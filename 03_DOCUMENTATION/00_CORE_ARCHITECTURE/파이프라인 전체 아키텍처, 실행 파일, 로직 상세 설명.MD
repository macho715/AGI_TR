
# 파이프라인 전체 아키텍처 및 실행 파일 상세 문서

**작성일**: 2025-12-27
**버전**: v4.5 (Complete Architecture Documentation)
**버전 정책**: 이 문서는 전체 아키텍처 통합 문서로, 다른 문서(v3.1)와 별도 버전 체계 사용
**목적**: 파이프라인 전체 아키텍처, 실행 파일, 로직 상세 설명

**최신 업데이트 (v4.5 - 2025-12-29):**
- bplus_inputs 폴더 구조 및 입력 데이터 매핑 추가
- 파이프라인 단계별 입력 파일 매핑 상세화
- 탐색 순서 및 Tide Integration 우선순위 명시

**최신 업데이트 (v4.4 - 2025-12-29):**
- 파이프라인 실행 파일 전체 목록 추가 (21개 파일, 카테고리별 분류)
- 실행 방식별 분류 (subprocess, import 모듈, 동적 import)
- 활성화 조건 및 의존성 관계 명시

**최신 업데이트 (v4.3 - 2025-12-29):**
- Forecast_Tide_m 우선순위 변경: CLI `--forecast_tide` 값이 최우선 적용
  - `build_stage_table_from_stage_results()` 및 `enrich_stage_table_with_tide_ukc()` 함수에서 우선순위 재정의
  - `stage_table_unified.csv`와 `solver_ballast_summary.csv` 간 `Forecast_Tide_m` 완전 일치 보장
  - 자세한 내용: `17_TIDE_UKC_Calculation_Logic.md` 섹션 17.6.5 참조

**최신 업데이트 (v4.2 - 2025-12-28):**
- Option 2 구현 완료: Step 4b Ballast Sequence Generator 확장
  - `BALLAST_OPTION.csv` / `BALLAST_EXEC.csv` 분리 출력
  - `generate_sequence_with_carryforward()`: Start_t/Target_t carry-forward 구현
  - `generate_option_plan()`: Delta_t 계획 생성 (Stage 6B 포함)
  - `BALLAST_SEQUENCE.xlsx`에 3개 시트 (Ballast_Option, Ballast_Exec, Ballast_Sequence)
- Option 1 패치 제안 (미구현): Bryan Pack Forecast_tide_m 주입, Stage 5_PreBallast critical 적용

**최신 업데이트 (v4.1 - 2025-12-27):**
- GM 검증 v2b 상세 설명 추가, GM Grid 축 정렬 정보 보강

---

## 목차

1. [전체 아키텍처 개요](#1-전체-아키텍처-개요)
2. [실행 파일 목록 및 역할](#2-실행-파일-목록-및-역할)
3. [Step별 상세 로직](#3-step별-상세-로직)
4. [데이터 흐름 및 SSOT 통합](#4-데이터-흐름-및-ssot-통합)
5. [주요 함수 및 모듈 설명](#5-주요-함수-및-모듈-설명)
6. [입력/출력 파일 구조](#6-입력출력-파일-구조)
7. [에러 처리 및 로깅](#7-에러-처리-및-로깅)

---

## 1. 전체 아키텍처 개요

### 1.1 파이프라인 목적

Ballast Pipeline은 LCT BUSHRA 선박의 **Ballast Management** 작업을 자동화하고 최적화하기 위한 통합 파이프라인입니다.

**핵심 목표:**
- Stage별 Draft/Trim/GM 계산 및 검증
- Gate 준수 (AFT_MIN, FWD_MAX, Freeboard, UKC)
- Ballast Plan 최적화 (LP Solver + Heuristic Optimizer)
- 운영 준비 문서 자동 생성 (Sequence, Checklist, Valve Lineup)

### 1.2 아키텍처 레이어

```
┌─────────────────────────────────────────────────────────────┐
│ INPUT LAYER (JSON SSOT + Sensors)                           │
│ - tank_catalog_from_tankmd.json                             │
│ - Hydro_Table_Engineering.json                              │
│ - AGI_site_profile_COMPLETE_v1.json                         │
│ - current_t_*.csv (센서 데이터, 자동 탐색)                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ ORCHESTRATOR LAYER (Single Entry Point)                     │
│ - integrated_pipeline_defsplit_v2_gate270_split_v3_         │
│   auditpatched_autodetect.py                                │
│   • 경로 해결, 프로파일 로딩, SSOT 변환                      │
│   • Step 실행 제어, 출력 수집, Excel 병합                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ SSOT CSV LAYER (Solver/Optimizer 입력)                      │
│ - tank_ssot_for_solver.csv                                   │
│ - hydro_table_for_solver.csv                                │
│ - stage_table_unified.csv                                    │
│ - pipeline_stage_QA.csv                                     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ EXECUTION STEPS LAYER                                        │
│ - Step 1: TR Excel Generation                                │
│ - Step 1b: stage_results.csv 생성                           │
│ - Step 2: OPS Integrated Report                              │
│ - Step 3: LP Solver (Gate Compliance)                       │
│ - Step 4: Optimizer (Heuristic Optimization)                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ OUTPUT LAYER (Reports, Plans, Excel)                        │
│ - OPS_FINAL_R3_Report_Integrated.md                         │
│ - solver_ballast_plan.csv                                    │
│ - optimizer_ballast_plan.xlsx                                │
│ - PIPELINE_CONSOLIDATED_AGI_*.xlsx                          │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 핵심 설계 원칙

1. **SSOT (Single Source of Truth)**: 모든 데이터는 단일 소스에서 로드
2. **Definition Split**: Forecast Tide vs Required WL, Draft vs Freeboard/UKC 명확 분리
3. **Gate Unified System**: FWD/AFT/Freeboard/UKC 게이트 동시 강제
4. **Site-Agnostic**: AGI/DAS 모두 동일 로직 (프로파일만 변경)
5. **Iterative Refinement**: Hydrostatic Table 재보간으로 정확도 향상

---

## 2. 실행 파일 목록 및 역할

### 2.1 메인 오케스트레이터

**파일**: `integrated_pipeline_defsplit_v2_gate270_split_v3_auditpatched_autodetect.py`

**역할**:
- 전체 파이프라인 실행 제어
- 경로 해결 및 프로파일 로딩
- SSOT CSV 변환 (Tank, Hydro, Stage)
- Current_t 센서 데이터 자동 탐색 및 주입
- Step 1~4 실행 제어
- 출력 파일 수집 및 Excel 병합

**주요 함수**:
- `main()`: 메인 실행 함수
- `convert_tank_catalog_json_to_solver_csv()`: 탱크 카탈로그 → CSV 변환
- `convert_hydro_engineering_json_to_solver_csv()`: Hydro Table → CSV 변환
- `build_stage_table_from_stage_results()`: stage_results.csv → stage_table_unified.csv
- `generate_stage_QA_csv()`: Stage QA CSV 생성 (Gate 검증 포함)
- `resolve_current_t_sensor_csv()`: Current_t 센서 CSV 자동 탐색
- `inject_current_t_from_sensor_csv()`: Current_t 주입 및 diff_audit.csv 생성
- `apply_tank_overrides_from_profile()`: 프로파일에서 탱크 오버라이드 적용
- `generate_gate_fail_report_md()`: Gate FAIL 리포트 생성
- `step_run_script()`: Step 스크립트 실행 (서브프로세스 관리)

**입력 인자**:
- `--site`: 사이트 레이블 (AGI/DAS)
- `--profile_json`: Site 프로파일 JSON 경로
- `--current_t_csv`: Current_t 센서 CSV 경로 (자동 탐색 가능)
- `--current_t_strategy`: 센서 값 주입 전략 (override/fill_missing)
- `--from_step`, `--to_step`: 실행 범위 제어
- `--fwd_max`, `--aft_min`: Gate 값
- `--forecast_tide`, `--depth_ref`, `--ukc_min`: UKC 계산 파라미터

**출력**:
- `pipeline_out_<timestamp>/`: 출력 디렉토리
  - `ssot/`: SSOT CSV 파일들
  - `logs/`: Step별 실행 로그
  - `gate_fail_report.md`: Gate FAIL 리포트
  - `TUG_Operational_SOP_DNV_ST_N001.md`: TUG 운영 SOP
  - `PIPELINE_CONSOLIDATED_AGI_*.xlsx`: 통합 Excel 파일

### 2.2 Step 1: TR Excel Generation

**파일**: `agi_tr_patched_v6_6_defsplit_v1.py`

**역할**:
- Stage별 Draft/Trim/GM 계산 (Engineering-grade)
- TR Excel 파일 생성 (`LCT_BUSHRA_AGI_TR_Final_v*.xlsx`)
- CSV 모드: `stage_results.csv` 생성 (SSOT)

**주요 함수**:
- `solve_stage()`: Stage별 Draft/Trim/GM 계산
- `_load_hydro_table()`: Hydrostatic Table 로드
- `_load_gm2d_grid()`: GM 2D Grid 로드
- `gm_2d_bilinear()`: GM 2D 보간 (DISP×TRIM)
- `create_workbook_from_scratch()`: Excel 워크북 생성

**입력**:
- `Hydro_Table_Engineering.json`: Hydrostatic Table
- `LCT_BUSHRA_GM_2D_Grid.json`: GM 2D Grid (선택적)
- `tank_catalog_from_tankmd.json`: 탱크 카탈로그

**출력**:
- `LCT_BUSHRA_AGI_TR_Final_v*.xlsx`: TR Excel 파일
- `stage_results.csv`: Stage 결과 CSV (CSV 모드)

**특징**:
- Engineering-grade 계산: Hydro table 보간, GM 2D 보간
- Frame-based 좌표계: Frame 0 = AP (AFT), Frame 증가 = FWD, Midship = Frame 30.151 → x = 0.0
- 좌표 변환: `x = 30.151 - Fr` (x > 0 = AFT, x < 0 = FWD)
- SSOT 강제: Hydro table 필수 (fallback 제거)

### 2.3 Step 1b: stage_results.csv 생성

**실행**: `agi_tr_patched_v6_6_defsplit_v1.py csv`

**역할**:
- TR 스크립트를 CSV 모드로 실행하여 `stage_results.csv` 생성
- SSOT Stage 정의 (9개 Stage: Stage 1, 2, 3, 4, 5, 5_PreBallast, 6A_Critical, 6C, 7)

**출력**:
- `stage_results.csv`: Stage별 Draft/Trim/Disp_t 데이터

**중요성**:
- 이후 모든 리포트/검증 스크립트의 SSOT
- `ops_final_r3_integrated_defs_split_v4_patched.py`가 이 파일에서 Stage 정의 로드
- `stage_wise_load_transfer_excel_patched.py`가 이 파일에서 Stage Summary 로드

### 2.4 Step 2: OPS Integrated Report

**파일**: `ops_final_r3_integrated_defs_split_v4_patched.py`

**역할**:
- OPS 통합 리포트 생성 (Excel + Markdown)
- Engineering-grade 계산 통합 (agi_tr_patched 엔진 사용)
- SSOT Stage 정의 로드 (`stage_results.csv`)

**주요 함수**:
- `generate_ops_report()`: OPS 리포트 생성
- `load_stage_data_from_ssot()`: stage_results.csv에서 Stage 데이터 로드

**입력**:
- `stage_results.csv`: SSOT Stage 정의
- `Hydro_Table_Engineering.json`: Hydrostatic Table
- `LCT_BUSHRA_GM_2D_Grid.json`: GM 2D Grid (선택적)

**출력**:
- `OPS_FINAL_R3_AGI_Ballast_Integrated.xlsx`: OPS Excel 리포트
- `OPS_FINAL_R3_Report_Integrated.md`: OPS Markdown 리포트

**특징**:
- SSOT 통합: `stage_results.csv`에서 Stage 정의 로드 (하드코딩 제거)
- Engineering-grade: Hydro table 보간, GM 2D 보간
- VOID3 분석 포함

### 2.5 Step 3: LP Solver (Gate Compliance)

**파일**: `ballast_gate_solver_v4.py`

**역할**:
- Linear Programming 기반 Ballast Plan 생성
- Gate 준수 강제 (FWD_MAX, AFT_MIN, Freeboard, UKC)
- Operability enforcement (DISCHARGE_ONLY, FILL_ONLY, BLOCKED)

**주요 함수**:
- `solve_ballast_plan()`: LP Solver 실행
- `_build_lp_problem()`: LP 문제 구성
- `_apply_hydro_iteration()`: Hydrostatic Table 재보간

**입력**:
- `tank_ssot_for_solver.csv`: 탱크 SSOT
- `hydro_table_for_solver.csv`: Hydro Table SSOT
- `stage_table_unified.csv`: Stage Table SSOT

**출력**:
- `solver_ballast_plan.csv`: 탱크별 Ballast Plan
- `solver_ballast_summary.csv`: Stage별 요약
- `solver_ballast_stage_plan.csv`: Stage별 Ballast Plan

**특징**:
- Definition-split: Forecast Tide vs Required WL 분리
- Unified gates: FWD/AFT/Freeboard/UKC 동시 강제
- Iterative refinement: Hydrostatic Table 재보간 (2회 반복)

### 2.6 Step 4: Optimizer (Heuristic Optimization)

**파일**: `Untitled-2_patched_defsplit_v1_1.py`

**역할**:
- Heuristic 기반 Ballast Plan 최적화
- 시간/용량 우선순위 선택 가능
- BWRB (Ballast Water Record Book) 로깅

**주요 함수**:
- `optimize_ballast_plan()`: 최적화 실행
- `_heuristic_selection()`: Heuristic 탱크 선택

**입력**:
- `tank_ssot_for_solver.csv`: 탱크 SSOT
- `hydro_table_for_solver.csv`: Hydro Table SSOT
- `stage_table_unified.csv`: Stage Table SSOT

**출력**:
- `optimizer_ballast_plan.xlsx`: 최적화된 Ballast Plan Excel
- `optimizer_plan.csv`: 최적화된 Ballast Plan CSV
- `optimizer_summary.csv`: 최적화 요약

**특징**:
- AFT_Limit_m는 상한(MAX)으로 사용 (AFT_MIN은 Step 3에서 강제)
- 시간 우선순위 또는 용량 우선순위 선택 가능

### 2.8 Step 4b: Ballast Sequence Generator (Option 2 구현 완료)

**파일**: `ballast_sequence_generator.py`, `checklist_generator.py`

**역할:**
- Ballast 계획을 실행 시퀀스로 변환
- Option 2 구현: 옵션/실행 분리, Start_t/Target_t carry-forward

**주요 함수**:
- `generate_sequence_with_carryforward()`: 실행 시퀀스 생성 (Start_t/Target_t 체인, Stage 6B 제외)
- `generate_option_plan()`: 옵션 계획 생성 (Delta_t 중심, Stage 6B 포함)
- `export_to_option_dataframe()`: 옵션 계획 DataFrame 생성
- `export_to_exec_dataframe()`: 실행 시퀀스 DataFrame 생성
- `export_option_to_csv()`, `export_exec_to_csv()`: 분리된 CSV 생성

**입력**:
- `ballast_plan_df`: Ballast 계획 (Optimizer 또는 Solver 출력)
- `profile`: Site Profile (Gate 정의 등)
- `stage_drafts`: Stage별 Draft 정보
- `tank_catalog_df`: 탱크 카탈로그 (용량, Current_t 등)

**출력**:
- `BALLAST_OPTION.csv`: 계획 레벨 (Delta_t 중심, 모든 Stage 포함)
- `BALLAST_EXEC.csv`: 실행 시퀀스 (Start_t/Target_t 체인, Stage 6B 제외)
- `BALLAST_SEQUENCE.csv`: Legacy (호환성)
- `BALLAST_SEQUENCE.xlsx`: Excel (Ballast_Option, Ballast_Exec, Ballast_Sequence 시트)
- `BALLAST_OPERATIONS_CHECKLIST.md`: 운영 체크리스트
- `HOLD_POINT_SUMMARY.csv`: Hold Point 요약

**핵심 로직 (Option 2):**
1. **Start_t/Target_t carry-forward**:
   ```python
   tank_state: Dict[str, float] = initial_tank_current.copy()
   for step in sequence:
       start_t = tank_state.get(tank_id, 0.0)  # 이전 step의 target_t
       target_t = start_t + delta_t
       # 탱크 용량 검증
       if target_t > capacity_t:
           target_t = capacity_t
           delta_t = target_t - start_t
       tank_state[tank_id] = target_t  # 다음 step을 위해 업데이트
   ```
2. **Stage 6B 분리**:
   - `OPTIONAL_STAGES = ["Stage 6B Tide Window"]` 상수 정의
   - `exclude_optional_stages=True` 파라미터로 실행 시퀀스에서 제외
   - `generate_option_plan()`: 옵션 계획에는 Stage 6B 포함
3. **탱크 용량 검증**:
   - `target_t > Capacity_t` 시 자동 클리핑

**특징**:
- 옵션/실행 분리로 계획과 실행 시퀀스 명확히 구분
- Start_t/Target_t carry-forward로 탱크 상태 정확히 추적
- Stage 6B 분리로 실행 시퀀스 정합성 보장
- Excel 출력에 3개 시트 포함 (Option, Exec, Legacy)

### 2.9 Step 4c: Valve Lineup Generator

**파일**: `valve_lineup_generator.py`

**역할:**
- Ballast Sequence에 밸브 라인업 정보 추가
- 운영 절차서 생성

**입력**:
- `BALLAST_SEQUENCE.csv`: Ballast Sequence
- `valve_map.json`: 밸브 매핑 정보

**출력**:
- `BALLAST_SEQUENCE_WITH_VALVES.md`: 밸브 라인업 포함 운영 절차서

**특징**:
- 탱크별 Fill/Discharge 밸브 시퀀스 자동 생성
- 안전 절차 (vent, emergency valves) 포함

### 2.10 보조 스크립트

#### 2.10.1 GM 검증

**파일**: `verify_gm_stability_v2b.py`

**역할**:
- Stage별 GM 검증
- CLAMP 범위 감지 (VERIFY_CLAMP_RANGE)
- FSM 계수 검증 (VERIFY_FSM_MISSING)
- GM_eff 계산 (GM - FSM/Displacement)

**주요 기능**:
- **GM 2D Grid bilinear interpolation**: DISP×TRIM 축 기반 2차원 보간
- **CLAMP 범위 자동 감지**: GM Grid 경계 밖 값에 대해 VERIFY_CLAMP_RANGE 상태 설정
- **FSM 통합**: FSM 계수를 사용한 GM_eff 계산 (`GM_eff = GM_raw - FSM/Displacement`)
- **CLAMP 요약 리포트**: `summarize_clamp_report.py`로 자동 생성

**입력**:
- `pipeline_stage_QA.csv`: Stage QA 데이터 (Disp_t, Trim_cm 포함)
- `LCT_BUSHRA_GM_2D_Grid.json`: GM 2D Grid (DISP×TRIM 축, `grid_axis` 메타데이터 포함)
- `Tank_FSM_Coeff.json`: FSM 계수 (선택적, t·m 단위)

**출력**:
- `gm_stability_verification_v2b.csv`: GM 검증 결과
  - 컬럼: Stage, Disp_t, Trim_cm, GM_raw, GM_eff, FSM_tm, CLAMP_Status, VERIFY_CLAMP_RANGE, VERIFY_FSM_MISSING
  - CLAMP_Status: "IN_RANGE" | "CLAMPED" | "OUT_OF_RANGE"
  - VERIFY_CLAMP_RANGE: "PASS" | "WARN" | "FAIL"
  - VERIFY_FSM_MISSING: "PASS" | "WARN" (FSM 계수 누락 시)

**특징**:
- Engineering-grade: 실제 GM Grid 보간 사용 (fallback 값 제거)
- FSM 영향 반영: GM_eff로 실제 안정성 평가
- CLAMP 감지: Grid 범위 밖 값 자동 감지 및 경고

#### 2.7.2 GM Grid 생성

**파일**: `build_gm_grid_json_v2.py`

**역할**:
- GM Table CSV → GM Grid JSON 변환
- DISP×TRIM 축 표준화
- `grid_axis` 메타데이터 추가

**주요 개선사항 (v2)**:
- **축 정렬 표준화**: TRIM × DISP → DISP × TRIM (표준화)
- **메타데이터 추가**: `grid_axis` 필드로 축 정보 명시 (`{"x": "DISP", "y": "TRIM"}`)
- **호환성**: `verify_gm_stability_v2b.py`와 완전 호환
- **보간 효율성**: DISP×TRIM 축으로 보간 성능 향상

**입력**:
- `GM_table.csv`: GM Table (long 포맷 또는 matrix 포맷)
  - Long 포맷: `DISP, TRIM, GM` 컬럼
  - Matrix 포맷: 행=TRIM, 열=DISP

**출력**:
- `LCT_BUSHRA_GM_2D_Grid.json`: GM 2D Grid JSON
  - 구조: `{"grid_axis": {"x": "DISP", "y": "TRIM"}, "data": {...}, "x_axis": [...], "y_axis": [...]}`
  - `x_axis`: DISP 값 배열 (정렬됨)
  - `y_axis`: TRIM 값 배열 (정렬됨)
  - `data`: 2D Grid 데이터 (DISP×TRIM 매트릭스)

**특징**:
- 표준화된 축 정렬로 일관성 보장
- 메타데이터로 Grid 구조 명확화
- `verify_gm_stability_v2b.py`와 완전 호환

#### 2.7.3 FSM 변환

**파일**: `convert_fsm_knm_to_tm.py`

**역할**:
- FSM 계수 단위 변환 (kN·m → t·m)
- 변환식: `t·m = (kN·m) / 9.80665`

**입력**:
- `Tank_FSM_Coeff_kNm.json`: FSM 계수 (kN·m)

**출력**:
- `Tank_FSM_Coeff.json`: FSM 계수 (t·m)

#### 2.7.4 Hold Point 관리

**파일**: `hold_point_manager.py`, `hold_point_cli.py`, `hold_point_recalculator.py`

**역할**:
- Hold Point 측정값 처리
- GO/RECALC/STOP 판정 (±2cm/±4cm 기준)
- 재계산 로직

#### 2.7.5 Excel 최종화

**파일**: `ballast_excel_finalize.py`

**역할**:
- Excel 파일 수식 최종화 (COM post-processing)
- RefreshAll + CalculateFullRebuild
- Calc_Log 시트 생성

### 2.11 파이프라인 실행 파일 전체 목록 (v4.4 업데이트)

**최신 검증일**: 2025-12-29
**총 실행 파일 수**: 21개 (중복 제외, 모듈 포함)

#### 2.11.1 필수 실행 파일 (Main Pipeline Steps)

| Step | 스크립트 파일명 | 기본 경로 | 실행 방식 | 설명 |
|------|---------------|---------|----------|------|
| **Step 0** | `agi_spmt_unified.py` | `spmt v1/agi_spmt_unified.py` | `subprocess` | SPMT cargo 입력 생성 (선택적) |
| **Step 1** | `agi_tr_patched_v6_6_defsplit_v1.py` | `agi_tr_patched_v6_6_defsplit_v1.py` | `subprocess` | TR Excel 생성 (선택적) |
| **Step 1b** | `agi_tr_patched_v6_6_defsplit_v1.py` | 동일 | `subprocess` | `stage_results.csv` 생성 (필수, csv 모드) |
| **Step 2** | `ops_final_r3_integrated_defs_split_v4_patched_TIDE_v1.py` | `ops_final_r3_integrated_defs_split_v4_patched_TIDE_v1.py` | `subprocess` | OPS Integrated 리포트 (Excel + MD) |
| **Step 3** | `ballast_gate_solver_v4_TIDE_v1.py` | `tide/ballast_gate_solver_v4_TIDE_v1.py` | `subprocess` | Ballast Gate Solver (LP) |
| **Step 4** | `Untitled-2_patched_defsplit_v1_1.py` | `Untitled-2_patched_defsplit_v1_1.py` | `subprocess` | Ballast Optimizer (선택적) |
| **Step 5** | `bryan_template_unified_TIDE_v1.py` | `tide/bryan_template_unified_TIDE_v1.py` | `subprocess` | Bryan Template 생성 및 채움 |

#### 2.11.2 선택적 실행 파일 (Optional Steps)

| Step | 스크립트 파일명 | 기본 경로 | 실행 방식 | 활성화 조건 |
|------|---------------|---------|----------|------------|
| **Step 4b** | `ballast_sequence_generator.py` | `ballast_sequence_generator.py` | `import` (모듈) | `--enable-sequence` |
| **Step 4b** | `checklist_generator.py` | `checklist_generator.py` | `import` (모듈) | `--enable-sequence` |
| **Step 4c** | `valve_lineup_generator.py` | `valve_lineup_generator.py` | `import` (모듈) | `--enable-valve-lineup` |

#### 2.11.3 의존 실행 파일 (Dependencies)

| 부모 스크립트 | 의존 스크립트 | 기본 경로 | 실행 방식 | 설명 |
|-------------|-------------|---------|----------|------|
| `bryan_template_unified_TIDE_v1.py` | `create_bryan_excel_template_NEW.py` | `create_bryan_excel_template_NEW.py` | `subprocess` | Bryan Template 생성 (Step 5 내부) |
| `bryan_template_unified_TIDE_v1.py` | `populate_template.py` | `populate_template.py` | `import` (임베디드) | Template 채움 로직 (Step 5 내부) |

#### 2.11.4 후처리 실행 파일 (Post-Processing)

| 스크립트 파일명 | 기본 경로 | 실행 방식 | 활성화 조건 | 설명 |
|---------------|---------|----------|------------|------|
| `excel_com_recalc_save.py` | `tide/excel_com_recalc_save.py` | `subprocess` | `EXCEL_COM_RECALC_OUT` 환경 변수 설정 시 | Excel 수식 재계산 (COM) |
| `ballast_excel_finalize.py` | `tide/ballast_excel_finalize.py` | `subprocess` | 파일 존재 시 자동 실행 | Excel 수식 최종화 |

#### 2.11.5 유틸리티 실행 파일 (Utilities)

| 스크립트 파일명 | 기본 경로 | 실행 방식 | 활성화 조건 | 설명 |
|---------------|---------|----------|------------|------|
| `compile_headers_registry.py` | `compile_headers_registry.py` | `import` (동적) | `HEADERS_MASTER.xlsx` 존재 시 자동 실행 | HEADERS_MASTER.xlsx → headers_registry.json 컴파일 |
| `debug_report.py` | `debug_report.py` | `import` (동적) | `--debug_report` 또는 `--auto_debug_report` | 디버그 리포트 생성 (선택적) |

#### 2.11.6 모듈 의존성 (Module Dependencies)

| 모듈 경로 | 사용 위치 | 실행 방식 | 설명 |
|---------|---------|----------|------|
| `ssot.gates_loader` | Step 4b | `import` | `SiteProfile`, `load_agi_profile` (프로파일 로딩) |
| `ssot.data_quality_validator` | Step 3, Step 4b | `import` | `DataQualityValidator` (Tidying First Implementation) |
| `tide.tide_ukc_engine` | 여러 Step | `import` | Tide/UKC 계산 SSOT 엔진 |
| `tide.tide_constants` | 여러 Step | `import` | Tide/UKC 상수 |

#### 2.11.7 Pre-Step 실행 파일 (선택적)

| 스크립트 파일명 | 기본 경로 | 실행 방식 | 활성화 조건 | 설명 |
|---------------|---------|----------|------------|------|
| `tide_stage_mapper.py` | `tide_stage_mapper.py` | 수동 실행 (Pre-Step) | `--tide_windows` 제공 시 | Stage별 조위 매핑 (AGI-only) |

#### 2.11.8 실행 파일 통계

| 카테고리 | 개수 | 비고 |
|---------|------|------|
| **필수 실행 파일 (subprocess)** | 4개 | Step 1b, Step 2, Step 3 (항상 실행) |
| **선택적 실행 파일 (subprocess)** | 3개 | Step 0, Step 1, Step 4, Step 5 |
| **선택적 실행 파일 (import 모듈)** | 3개 | Step 4b, Step 4c |
| **의존 실행 파일** | 2개 | Bryan Template 내부 호출 |
| **후처리 실행 파일** | 2개 | Excel 최종화 |
| **유틸리티 실행 파일** | 2개 | Headers registry 컴파일, Debug report |
| **모듈 의존성** | 4개 | SSOT 모듈들 (import) |
| **Pre-Step 실행 파일** | 1개 | Tide mapping (수동 실행) |
| **총계** | **21개** | (중복 제외, 모듈 포함) |

**참고**:
- 모든 실행 파일은 `integrated_pipeline_defsplit_v2_gate270_split_v3_auditpatched_autodetect_TIDE_v1.py`에서 `step_run_script()`, `subprocess.run()`, 또는 동적 `import`로 호출됩니다.
- 스크립트 경로는 `resolve_script_path()` 함수로 자동 탐색됩니다 (`tide/` 디렉토리에서 실행해도 상위 폴더 스크립트 자동 인식).

---

### 2.12 bplus_inputs 폴더 구조 및 입력 데이터 매핑 (v4.5 신규)

**최신 업데이트**: 2025-12-29
**목적**: 파이프라인 입력 데이터 소스 및 탐색 순서 명확화

#### 2.12.1 폴더 구조

```
01_EXECUTION_FILES/bplus_inputs/
├── data/                                    # Frame ↔ x 변환 데이터
│   └── Frame_x_from_mid_m.json            # Frame 좌표계 변환 테이블
│
├── profiles/                                # Site profile
│   └── AGI.json                            # AGI site profile (기본)
│
├── stage_schedule.csv                      # Stage별 타임스탬프 (tide 보간용)
├── stage_schedule.sample.csv               # 샘플 파일
├── tide_windows_AGI.json                  # Stage별 tide window 정의
├── water tide_202512.xlsx                  # Tide 데이터 (Excel, 2025-12)
│
├── Hydro_Table_Engineering.json           # Hydrostatic 테이블 (엔지니어링 버전)
├── LCT_BUSHRA_GM_2D_Grid.json            # GM 2D Grid (GM 검증용)
├── Tank_FSM_Coeff.json                    # FSM 계수 (GM 검증용)
│
├── Acceptance_Criteria.json               # 승인 기준
├── GM_Min_Curve.json                      # GM 최소 곡선
├── ISCODE_Criteria.json                   # ISCODE 기준
├── Securing_Input.json                    # 고정 입력
└── Structural_Limits.json                 # 구조적 제한
```

#### 2.12.2 파이프라인 단계별 입력 파일 매핑

| Step | 입력 파일 | 경로 | 사용 목적 | 필수 여부 |
|------|----------|------|----------|----------|
| **Step 1** (TR Excel) | `Hydro_Table_Engineering.json` | `bplus_inputs/` | Hydrostatic 데이터 | 필수 |
| | `data/Frame_x_from_mid_m.json` | `bplus_inputs/data/` | Frame ↔ x 변환 | 필수 |
| **Step 2** (OPS) | `profiles/AGI.json` | `bplus_inputs/profiles/` | Site profile (자동 탐색) | 필수 |
| | `Hydro_Table_Engineering.json` | `bplus_inputs/` | Hydrostatic 데이터 | 필수 |
| **Step 2** (Tide Integration) | `stage_schedule.csv` | `bplus_inputs/` | Stage별 타임스탬프 (tide 보간용) | 선택적 |
| | `water tide_202512.xlsx` | `bplus_inputs/` | Tide 데이터 (Excel) | 선택적 |
| | `tide_windows_AGI.json` | `bplus_inputs/` | Stage별 tide window 정의 | 선택적 |
| **Step 3** (Solver) | `Hydro_Table_Engineering.json` | `bplus_inputs/` | Hydrostatic 데이터 (간접) | 필수 |
| **Step 5** (Post-processing) | `LCT_BUSHRA_GM_2D_Grid.json` | `bplus_inputs/` | GM 2D Grid (GM 검증) | 선택적 |
| | `Tank_FSM_Coeff.json` | `bplus_inputs/` | FSM 계수 (GM 검증) | 선택적 |
| | `Acceptance_Criteria.json` | `bplus_inputs/` | 승인 기준 | 선택적 |
| | `GM_Min_Curve.json` | `bplus_inputs/` | GM 최소 곡선 | 선택적 |
| | `ISCODE_Criteria.json` | `bplus_inputs/` | ISCODE 기준 | 선택적 |
| | `Securing_Input.json` | `bplus_inputs/` | 고정 입력 | 선택적 |
| | `Structural_Limits.json` | `bplus_inputs/` | 구조적 제한 | 선택적 |

#### 2.12.3 주요 입력 파일 상세

##### 1. `Hydro_Table_Engineering.json`
- **용도**: Hydrostatic 테이블 (엔지니어링 버전)
- **형식**: JSON (Disp_t, Draft_m, MTC, TPC, LCF 등)
- **사용 위치**: Step-1, Step-2, Step-3
- **필수 여부**: 필수
- **탐색 경로**:
  - `inputs_dir/bplus_inputs/Hydro_Table_Engineering.json`
  - `base_dir/bplus_inputs/Hydro_Table_Engineering.json`
  - `--hydro` 인자로 명시적 지정 가능

##### 2. `stage_schedule.csv`
- **용도**: Stage별 타임스탬프 (tide table 보간용)
- **형식**: CSV (`Stage,Timestamp`)
- **사용 위치**: Step-2 (Tide Integration)
- **필수 여부**: 선택적 (`--tide_table`과 함께 사용)
- **예시**:
  ```csv
  Stage,Timestamp
  Stage 1,2025-12-01 08:00:00
  Stage 6A_Critical (Opt C),2025-12-01 20:00:00
  ```

##### 3. `tide_windows_AGI.json`
- **용도**: Stage별 tide window 정의 (시작/종료 시간, 통계량)
- **형식**: JSON (`{"tide_windows": {"Stage 1": {"start": "...", "end": "...", "stat": "mean"}}}`)
- **사용 위치**: Step-2 (Tide Integration, 선택적)
- **필수 여부**: 선택적

##### 4. `water tide_202512.xlsx`
- **용도**: Tide 데이터 (Excel 형식, 2025-12)
- **형식**: Excel (576 lines)
- **사용 위치**: Step-2 (Tide Integration, `--tide_table` 인자로 지정)
- **필수 여부**: 선택적

##### 5. `profiles/AGI.json`
- **용도**: Site profile (tank operability, gates, tide/UKC 설정 등)
- **형식**: JSON
- **사용 위치**: Step-2, Step-3
- **필수 여부**: 필수 (자동 탐색 지원)
- **탐색 경로**:
  - `inputs_dir/bplus_inputs/profiles/AGI.json`
  - `inputs_dir/bplus_inputs/profiles/site_AGI.json`
  - `inputs_dir/bplus_inputs/site_profile_AGI.json`

##### 6. `data/Frame_x_from_mid_m.json`
- **용도**: Frame ↔ x 변환 테이블
- **형식**: JSON
- **사용 위치**: Step-1
- **필수 여부**: 필수
- **탐색 경로**:
  - `base_dir/bplus_inputs/data/Frame_x_from_mid_m.json`
  - `base_dir/bplus_inputs/Frame_x_from_mid_m.json`
  - `02_RAW_DATA/Frame_x_from_mid_m.json` (fallback)

#### 2.12.4 `02_RAW_DATA` vs `01_EXECUTION_FILES/bplus_inputs` 비교

| 항목 | `02_RAW_DATA` | `01_EXECUTION_FILES/bplus_inputs` |
|------|--------------|----------------------------------|
| 위치 | 프로젝트 루트 | 실행 파일 디렉토리 |
| 용도 | 원본 데이터 저장소 | 실행 시 입력 데이터 |
| 파일 중복 | 일부 파일 중복 가능 | 일부 파일 중복 가능 |
| 우선순위 | Fallback | Primary (실행 파일 근처) |
| 탐색 순서 | 2순위 | 1순위 |

**파이프라인 탐색 순서**:
1. `inputs_dir/bplus_inputs/` (또는 `base_dir/bplus_inputs/`)
2. `02_RAW_DATA/` (fallback)

#### 2.12.5 Tide Integration 우선순위 (5-tier)

1. **Priority 0**: CLI `--forecast_tide` (최우선)
2. **Priority 1**: `stage_tide_csv` (예: `stage_tide_AGI.csv`)
3. **Priority 2**: `tide_table` + `stage_schedule` 보간
   - `water tide_202512.xlsx` + `stage_schedule.csv`
4. **Priority 3**: `tide_windows_AGI.json` (선택적)
5. **Priority 4**: Profile fallback 또는 기본값

**참고**: 자세한 내용은 `17_TIDE_UKC_Calculation_Logic.md` 섹션 17.6 참조.

---

## 3. Step별 상세 로직

### 3.1 Step 1: TR Excel Generation

**실행 조건**: `args.from_step <= 1 <= args.to_step`

**실행 명령**:
```python
python agi_tr_patched_v6_6_defsplit_v1.py
```

**로직**:
1. Hydrostatic Table 로드 (`Hydro_Table_Engineering.json`)
2. GM 2D Grid 로드 (`LCT_BUSHRA_GM_2D_Grid.json`, 선택적)
3. Stage별 계산:
   - Load items 정의 (TR1, TR2, Preballast 등)
   - `solve_stage()` 호출:
     - Displacement 계산
     - Hydro table 보간 (LCF, MCTC, TPC)
     - Draft/Trim 계산
     - GM 2D 보간 (DISP×TRIM)
4. Excel 워크북 생성:
   - Stage별 시트
   - Hydro table 시트
   - GM Grid 시트
   - Frame table 시트

**출력**:
- `LCT_BUSHRA_AGI_TR_Final_v*.xlsx`: TR Excel 파일
- `RORO_Summary.png`: RORO 요약 그래프 (선택적)

**에러 처리**:
- Step 1 실패 시 경고만 출력 (선택적 단계)
- `stage_results.csv`가 이미 존재하면 Step 1b 스킵 가능

### 3.2 Step 1b: stage_results.csv 생성

**실행 조건**: `args.from_step <= 1 <= args.to_step` AND `stage_results.csv` 없음

**실행 명령**:
```python
python agi_tr_patched_v6_6_defsplit_v1.py csv
```

**로직**:
1. TR 스크립트를 CSV 모드로 실행
2. Stage별 결과를 CSV로 출력:
   - Stage, Dfwd_m, Daft_m, Disp_t, Tmean_m, Trim_cm 등
3. `stage_results.csv` 생성 (SSOT)

**에러 처리**:
- Step 1b 실패 시 파이프라인 중단 (`return 1`)
- `stage_results.csv`가 없으면 이후 Step 실행 불가

### 3.3 PREP: SSOT CSV 변환

**실행 순서**: Step 1b 이후, Step 2 이전

#### 3.3.1 Tank SSOT 변환

**함수**: `convert_tank_catalog_json_to_solver_csv()`

**로직**:
1. `tank_catalog_from_tankmd.json` 로드
2. 각 탱크에 대해:
   - 좌표 변환: `x_from_mid_m = MIDSHIP_FROM_AP_M - lcg_from_ap_m`
     - `lcg_from_ap_m`: 탱크 LCG (AP 기준, m)
     - `x_from_mid_m > 0`: AFT zone, `x_from_mid_m < 0`: FWD zone
   - 키워드 필터링: `include_keywords` (기본: BALLAST, VOID, FWB, FW, DB)
   - `use_flag` 설정: 키워드 매칭 시 "Y"
   - Priority weight 설정: FWB2=1.0, VOIDDB2=2.0, VOIDDB1=3.0, 기타=5.0
3. CSV 출력: `tank_ssot_for_solver.csv`

**주의사항**: FWD zone 탱크(`FWB1.*`, `FWB2.*`)는 선수 탱크이므로 "선미 ballast"로 사용하면 물리 법칙이 뒤집혀 Gate가 깨집니다. AFT-up이 필요하면 AFT zone 탱크를 사용해야 합니다.

**출력 컬럼**:
- Tank, Capacity_t, x_from_mid_m, Current_t, Min_t, Max_t, mode, use_flag, pump_rate_tph, priority_weight

#### 3.3.2 Current_t 센서 주입

**함수**: `inject_current_t_from_sensor_csv()`

**자동 탐색 로직** (`resolve_current_t_sensor_csv()`):
1. 명시적 `--current_t_csv` 인자 확인
2. 고정 경로 후보 탐색:
   - `inputs_dir/current_t_sensor.csv`
   - `inputs_dir/current_t.csv`
   - `inputs_dir/sensors/current_t_sensor.csv`
   - `inputs_dir/sensors/current_t.csv`
   - `inputs_dir/plc/current_t.csv`
   - `inputs_dir/iot/current_t.csv`
3. Fallback 자동 탐색:
   - 탐색 디렉토리: `inputs_dir`, `inputs_dir/sensors`, `base_dir`, `base_dir/sensors`
   - 패턴: `current_t_*.csv`, `current_t-*.csv`
   - 선택 기준: 최신 수정 시간 (mtime) 우선

**주입 로직**:
1. 센서 CSV 로드 및 컬럼 정규화:
   - Tank identifier: Tank | tank_id | id | tag | name
   - Value (우선순위):
     1) Current_t | tons | ton | amount_t | value_t
     2) level_pct | level_percent (Capacity_t 사용)
     3) volume_m3 | m3 + optional spgr (기본 1.0)
2. 매칭 전략:
   - Exact match: 탱크 ID 정확히 일치
   - Group match: Base name 일치 (예: FWB2 → FWB2.P, FWB2.S 균등 분배)
3. Strategy 적용:
   - `override`: 항상 센서 값으로 덮어쓰기
   - `fill_missing`: 기존 값이 0.0일 때만 주입
4. Clamping: Min_t/Max_t 범위 내로 제한
5. diff_audit.csv 생성:
   - 주입 전/후 값 비교
   - Clamping 여부 기록
   - 스킵 사유 기록

**출력**:
- `tank_ssot_for_solver.csv`: 업데이트된 탱크 SSOT
- `diff_audit.csv`: 주입 이력 (TS, Tank, CurrentOld_t, ComputedNew_t, Delta_t, ClampedFlag, Updated, SkipReason)

#### 3.3.3 Tank Overrides 적용

**함수**: `apply_tank_overrides_from_profile()`

**로직**:
1. Site 프로파일에서 `tank_overrides` 섹션 로드
2. 각 오버라이드에 대해:
   - Exact match: 탱크 ID 정확히 일치
   - Base match: Base name 일치 (예: FW2 → FW2.P, FW2.S)
     - Base match는 명시적 허용 필요 (`allow_base_match: true`)
3. 오버라이드 적용:
   - `use_flag`: Y/N
   - `mode`: FILL_DISCHARGE, DISCHARGE_ONLY, FILL_ONLY, BLOCKED
   - `pump_rate_tph`: 펌프 속도
   - `operability`: NORMAL, PRE_BALLAST_ONLY, DISCHARGE_ONLY 등

**출력**:
- `tank_ssot_for_solver.csv`: 오버라이드 적용된 탱크 SSOT

#### 3.3.4 Hydro SSOT 변환

**함수**: `convert_hydro_engineering_json_to_solver_csv()`

**로직**:
1. `Hydro_Table_Engineering.json` 로드
2. 컬럼 정규화:
   - `MCTC_t_m_per_cm` → `MTC_t_m_per_cm`
   - `LCF_m_from_midship` → `LCF_m`
3. 필수 컬럼 확인: Tmean_m, TPC_t_per_cm, MTC_t_m_per_cm, LCF_m
4. LBP_m 추가 (없으면 기본값 사용)
5. CSV 출력: `hydro_table_for_solver.csv`

**출력 컬럼**:
- Tmean_m, TPC_t_per_cm, MTC_t_m_per_cm, LCF_m, LBP_m

#### 3.3.5 Stage Table 빌드

**함수**: `build_stage_table_from_stage_results()`

**로직**:
1. `stage_results.csv` 로드
2. 컬럼 추론:
   - Stage: Stage | stage_name | name
   - FWD Draft: Dfwd_m | FWD_m | Fwd Draft(m)
   - AFT Draft: Daft_m | AFT_m | Aft Draft(m)
   - Displacement: Disp_t | disp | displacement_t
   - Tmean: Tmean_m | tmean | mean_draft_m
   - Trim: Trim_cm | trim
3. Draft clipping: Molded Depth (D_vessel_m) 초과 방지
4. Gate 값 추가:
   - FWD_MAX_m: `fwd_max_m` (기본 2.70m)
   - AFT_MIN_m: `aft_min_m` (기본 2.70m)
   - AFT_MAX_m: `aft_max_m_for_optimizer` (기본 3.50m)
5. Critical stage 마킹:
   - `critical_regex` 또는 `critical_stage_list`로 매칭
   - Gate-B 적용 여부 결정
6. UKC 파라미터 추가 (제공된 경우):
   - Forecast_Tide_m, Depth_Ref_m, UKC_MIN_m
7. Hydro range 검증:
   - Displacement가 Hydro table 범위 내인지 확인
   - HardStop 플래그 설정
8. CSV 출력: `stage_table_unified.csv`

**출력 컬럼**:
- Stage, Current_FWD_m, Current_AFT_m, FWD_MAX_m, AFT_MIN_m, AFT_MAX_m, D_vessel_m, Forecast_Tide_m, Depth_Ref_m, UKC_MIN_m, Gate_B_Applies, HardStop, HardStop_Reason

#### 3.3.6 Stage QA CSV 생성

**함수**: `generate_stage_QA_csv()`

**로직**:
1. `stage_table_unified.csv` 로드
2. Draft 소스 설정:
   - `Draft_FWD_m_raw`, `Draft_AFT_m_raw`: 원본 값
   - `Draft_FWD_m`, `Draft_AFT_m`: Solver 결과 적용 시 업데이트
   - `Draft_Source`: "raw" 또는 "solver"
3. Freeboard 계산:
   - `Freeboard_FWD_m = D_vessel_m - Draft_FWD_m`
   - `Freeboard_AFT_m = D_vessel_m - Draft_AFT_m`
   - `Freeboard_Min_m = min(Freeboard_FWD_m, Freeboard_AFT_m)`
   - `Freeboard_Min_BowStern_m`: 명시적 라벨 (linkspan freeboard와 구분)
4. Gate 검증:
   - `Gate_FWD_Max`: FWD <= FWD_MAX_m (Chart Datum 기준, 적용 가능한 경우만)
   - `Gate_AFT_Min`: AFT >= AFT_MIN_m
   - `Gate_Freeboard`: Freeboard_Min_m >= 0 (deck wet/downflooding 방지)
   - `Gate_UKC`: UKC >= UKC_MIN_m (제공된 경우, grounding 방지)
   - `Gate_Hydro_Range`: Displacement가 Hydro table 범위 내
   - `Gate_AFT_MIN_2p70`: AFT >= 2.70m (Gate-A, Captain, 프로펠러 효율/추진 확보)
   - `Gate_FWD_MAX_2p70_critical_only`: FWD <= 2.70m (Gate-B, Mammoet, Critical RoRo stages만)
     - Critical stage 판정: `DEFAULT_CRITICAL_STAGE_REGEX` 또는 프로파일 `critical_stage_list`
     - Non-critical stages: `Gate_FWD_MAX_2p70_critical_only = "N/A"` (false failure 방지)
5. Margin 계산:
   - `FWD_Margin_m = FWD_MAX_m - Draft_FWD_m`
   - `AFT_Margin_m = Draft_AFT_m - AFT_MIN_m`
   - `AFT_Margin_2p70_m = Draft_AFT_m - 2.70`
   - `FWD_Margin_2p70_m = 2.70 - Draft_FWD_m`
6. HardStop 합성:
   - `HardStop_Any`: Y/N
   - `HardStop_Reason`: 원인 (OverDepth/DeckWet, HydroOutOfRange 등)
7. CSV 출력: `pipeline_stage_QA.csv`

**출력 컬럼**:
- Stage, Draft_FWD_m_raw, Draft_AFT_m_raw, Draft_FWD_m, Draft_AFT_m, Draft_Source, Freeboard_Min_m, Freeboard_Min_BowStern_m, Gate_FWD_Max, Gate_AFT_Min, Gate_Freeboard, Gate_UKC, Gate_Hydro_Range, Gate_AFT_MIN_2p70, Gate_FWD_MAX_2p70_critical_only, FWD_Margin_m, AFT_Margin_m, AFT_Margin_2p70_m, FWD_Margin_2p70_m, HardStop_Any, HardStop_Reason

### 3.4 Gate FAIL 리포트 생성

**함수**: `generate_gate_fail_report_md()`

**실행 조건**: `--no_gate_report` 플래그 없음

**로직**:
1. `pipeline_stage_QA.csv` 로드
2. Gate 위반 Stage 집계:
   - Gate_FWD_Max, Gate_AFT_Min, Gate_Freeboard, Gate_UKC
   - GateA_AFT_MIN_2p70_PASS, GateB_FWD_MAX_2p70_CD_PASS
   - Gate_Hydro_Range, HardStop
3. Heuristics 생성:
   - Current_t가 대부분 0.0인 경우 경고
   - Freeboard_Min_m < 0인 경우 경고
   - UKC Gate 미평가 경고
   - Hydro Range 위반 경고
   - HardStop 감지 경고
4. Markdown 리포트 생성:
   - Executive Summary
   - Gate 위반 요약
   - Stage별 Gate 상태 테이블
   - 자동 원인 추정
   - 권고 조치

**출력**:
- `gate_fail_report.md`: Gate FAIL 리포트

**추가 섹션**:
- DNV Mitigation Section (`append_dnv_mitigation_section_to_gate_report()`)
- TUG Operational SOP (`generate_tug_operational_sop_md()`)
- Solver Section (`append_solver_section_to_gate_report()`, Step 3 이후)

### 3.5 Step 2: OPS Integrated Report

**실행 조건**: `args.from_step <= 2 <= args.to_step`

**실행 명령**:
```python
python ops_final_r3_integrated_defs_split_v4_patched.py
```

**로직**:
1. SSOT Stage 데이터 로드:
   - `stage_results.csv`에서 Stage 정의 로드
   - 하드코딩된 Stage 정의 제거 (SSOT 통합)
2. Engineering-grade 계산:
   - `agi_tr_patched_v6_6_defsplit_v1` 엔진 사용
   - Hydro table 보간
   - GM 2D 보간
3. Excel 리포트 생성:
   - Stage별 시트
   - VOID3 분석 시트
   - Discharge 전략 시트
4. Markdown 리포트 생성:
   - Executive Summary
   - Stage Analysis
   - Calculation Methodology

**출력**:
- `OPS_FINAL_R3_AGI_Ballast_Integrated.xlsx`: OPS Excel 리포트
- `OPS_FINAL_R3_Report_Integrated.md`: OPS Markdown 리포트

**특징**:
- SSOT 통합: `stage_results.csv`에서 Stage 정의 로드
- Engineering-grade: Hydro table 보간, GM 2D 보간
- VOID3 분석 포함

### 3.6 Step 3: LP Solver

**실행 조건**: `args.from_step <= 3 <= args.to_step`

**실행 명령**:
```python
python ballast_gate_solver_v4.py \
  --tank tank_ssot_for_solver.csv \
  --hydro hydro_table_for_solver.csv \
  --mode limit \
  --stage stage_table_unified.csv \
  --iterate_hydro 2 \
  --fwd_max 2.70 \
  --aft_min 2.70 \
  --d_vessel 3.65 \
  --fb_min 0.0 \
  --squat 0.0 \
  --safety_allow 0.0 \
  --forecast_tide <value> \
  --depth_ref <value> \
  --ukc_min <value> \
  --out_plan solver_ballast_plan.csv \
  --out_summary solver_ballast_summary.csv \
  --out_stage_plan solver_ballast_stage_plan.csv
```

**로직**:
1. SSOT CSV 로드:
   - `tank_ssot_for_solver.csv`: 탱크 데이터
   - `hydro_table_for_solver.csv`: Hydro Table
   - `stage_table_unified.csv`: Stage 데이터
2. LP 문제 구성:
   - 변수: 각 탱크의 Fill/Discharge 양 (p_i, n_i)
   - 목적 함수: 최소화 (또는 목표 달성)
   - 제약 조건:
     - Gate 준수: FWD <= FWD_MAX, AFT >= AFT_MIN, Freeboard >= FB_MIN, UKC >= UKC_MIN
     - 탱크 용량: Min_t <= Current_t + Δw <= Max_t
     - Operability: DISCHARGE_ONLY, FILL_ONLY, BLOCKED 강제
3. Hydrostatic Table 재보간:
   - 초기 해 계산
   - Displacement 업데이트
   - Hydro table 재보간 (LCF, MCTC, TPC)
   - Draft/Trim 재계산
   - 반복 (기본 2회)
4. LP Solver 실행:
   - `scipy.optimize.linprog` 사용
   - 최적 해 또는 최적 근사 해 반환
5. 결과 출력:
   - `solver_ballast_plan.csv`: 탱크별 Ballast Plan
   - `solver_ballast_summary.csv`: Stage별 요약
   - `solver_ballast_stage_plan.csv`: Stage별 Ballast Plan

**출력 컬럼** (solver_ballast_summary.csv):
- Stage, New_FWD_m, New_AFT_m, New_Trim_m, Delta_W_t, Gate_FWD_Max, Gate_AFT_Min, Gate_Freeboard, Gate_UKC

**특징**:
- Definition-split: Forecast Tide vs Required WL 분리
- Unified gates: FWD/AFT/Freeboard/UKC 동시 강제
- Iterative refinement: Hydrostatic Table 재보간

### 3.7 Step 3 후: QA CSV 업데이트

**로직**:
1. `solver_ballast_summary.csv` 로드
2. `pipeline_stage_QA.csv` 업데이트:
   - `Draft_FWD_m`, `Draft_AFT_m`: Solver 결과로 업데이트
   - `Draft_Source`: "solver"로 변경
3. Gate 재검증:
   - Solver 적용 후 Draft로 Gate 재검증
   - Margin 재계산

**출력**:
- `pipeline_stage_QA.csv`: Solver 결과 반영된 QA CSV

### 3.8 Step 4: Optimizer

**실행 조건**: `args.from_step <= 4 <= args.to_step`

**실행 명령**:
```python
python Untitled-2_patched_defsplit_v1_1.py \
  --batch \
  --tank tank_ssot_for_solver.csv \
  --hydro hydro_table_for_solver.csv \
  --stage stage_table_unified.csv \
  --prefer_time \
  --iterate_hydro 2 \
  --out_plan optimizer_plan.csv \
  --out_summary optimizer_summary.csv \
  --out_stage_plan ballast_stage_plan.csv \
  --bwrb_out optimizer_bwrb_log.csv \
  --tanklog_out optimizer_tank_log.csv \
  --excel_out optimizer_ballast_plan.xlsx
```

**로직**:
1. SSOT CSV 로드
2. Heuristic 최적화:
   - 시간 우선순위 또는 용량 우선순위 선택
   - 탱크 선택 및 Fill/Discharge 양 결정
3. Gate 준수 확인:
   - AFT_Limit_m는 상한(MAX)으로 사용
   - AFT_MIN은 Step 3에서 이미 강제됨
4. Excel 출력:
   - Ballast Plan 시트
   - BWRB 로그 시트
   - 탱크 로그 시트

**출력**:
- `optimizer_ballast_plan.xlsx`: 최적화된 Ballast Plan Excel
- `optimizer_plan.csv`: 최적화된 Ballast Plan CSV
- `optimizer_summary.csv`: 최적화 요약
- `optimizer_bwrb_log.csv`: BWRB 로그
- `optimizer_tank_log.csv`: 탱크 로그

### 3.11 Step 4b: Ballast Sequence Generator (Option 2 구현 완료)

**실행 조건**: `args.from_step <= 4 <= args.to_step` AND `args.enable_sequence`

**실행 명령**:
```python
from ballast_sequence_generator import (
    generate_sequence_with_carryforward,
    generate_option_plan,
    export_to_option_dataframe,
    export_to_exec_dataframe,
    export_option_to_csv,
    export_exec_to_csv,
)

# 옵션 계획 생성 (모든 Stage 포함, Stage 6B 포함)
option_plan = generate_option_plan(
    ballast_plan_df,
    profile,
    stage_drafts,
    tank_catalog_df
)
option_df = export_to_option_dataframe(option_plan)
export_option_to_csv(option_df, "BALLAST_OPTION.csv")

# 실행 시퀀스 생성 (Stage 6B 제외, Start_t/Target_t carry-forward)
exec_sequence = generate_sequence_with_carryforward(
    ballast_plan_df,
    profile,
    stage_drafts,
    tank_catalog_df,
    exclude_optional_stages=True
)
exec_df = export_to_exec_dataframe(exec_sequence)
export_exec_to_csv(exec_df, "BALLAST_EXEC.csv")
```

**로직**:
1. Ballast Plan 로드 (Optimizer 또는 Solver 출력)
2. 옵션 계획 생성 (`generate_option_plan()`):
   - 모든 Stage 포함 (Stage 6B 포함)
   - Delta_t 중심 계획
3. 실행 시퀀스 생성 (`generate_sequence_with_carryforward()`):
   - Stage 순서 결정 (우선순위 기반 정렬)
   - 옵션 Stage 필터링 (Stage 6B 제외)
   - 각 Stage별 Sequence 생성:
     - 탱크 상태 초기화 (Current_t)
     - Start_t/Target_t carry-forward
     - 탱크 용량 검증 및 클리핑
4. Excel 출력:
   - `BALLAST_SEQUENCE.xlsx`에 3개 시트 생성:
     - `Ballast_Option`: 옵션 계획
     - `Ballast_Exec`: 실행 시퀀스
     - `Ballast_Sequence`: Legacy 형식

**출력**:
- `BALLAST_OPTION.csv`: 계획 레벨 (Stage, Tank, Action, Delta_t, PumpRate, Priority, Rationale)
- `BALLAST_EXEC.csv`: 실행 시퀀스 (Stage, Step, Tank, Action, Start_t, Target_t, Time_h, Valve_Lineup, Hold_Point)
- `BALLAST_SEQUENCE.csv`: Legacy (호환성)
- `BALLAST_SEQUENCE.xlsx`: Excel (3개 시트)
- `BALLAST_OPERATIONS_CHECKLIST.md`: 운영 체크리스트

**검증 포인트:**
- ✅ BALLAST_OPTION.csv에 Stage 6B 포함
- ✅ BALLAST_EXEC.csv에 Stage 6B 제외
- ✅ Start_t/Target_t 체인 연속성 (동일 탱크)
- ✅ 탱크 용량 초과 시 클리핑

### 3.12 Step 4c: Valve Lineup Generator

**실행 조건**: `args.from_step <= 4 <= args.to_step` AND `args.enable_valve_lineup`

**로직**:
1. `BALLAST_SEQUENCE.csv` 로드
2. `valve_map.json` 로드
3. 각 Step에 밸브 라인업 정보 추가
4. Markdown 운영 절차서 생성

**출력**:
- `BALLAST_SEQUENCE_WITH_VALVES.md`: 밸브 라인업 포함 운영 절차서

### 3.13 출력 파일 수집

**함수**: `collect_all_output_files()`

**로직**:
1. Step 1 출력 수집:
   - `LCT_BUSHRA_AGI_TR_Final_v*.xlsx`
   - `RORO_Summary.png`
2. Step 2 출력 수집:
   - `OPS_FINAL_R3_AGI_Ballast_Integrated.xlsx`
   - `OPS_FINAL_R3_Report_Integrated.md`
3. Step 4b 출력 수집 (Option 2):
   - `BALLAST_OPTION.csv`
   - `BALLAST_EXEC.csv`
   - `BALLAST_SEQUENCE.csv`
   - `BALLAST_SEQUENCE.xlsx`
   - `BALLAST_OPERATIONS_CHECKLIST.md`
   - `HOLD_POINT_SUMMARY.csv`
4. 입력 파일 복사:
   - `tank_catalog_from_tankmd.json`
   - `Hydro_Table_Engineering.json`
   - 기타 의존성 파일
4. `inputs/` 하위 디렉토리에 복사

### 3.10 Excel 파일 병합

**함수**: `merge_excel_files_to_one()`

**로직**:
1. Excel 파일 탐색:
   - `LCT_BUSHRA_AGI_TR_Final_v*.xlsx`
   - `OPS_FINAL_R3_AGI_Ballast_Integrated.xlsx`
   - `optimizer_ballast_plan.xlsx`
2. 워크북 병합:
   - 각 Excel 파일의 모든 시트를 하나의 워크북으로 복사
   - 시트 이름 충돌 시 파일명 prefix 추가
3. 저장:
   - `PIPELINE_CONSOLIDATED_AGI_<timestamp>.xlsx`

**출력**:
- `PIPELINE_CONSOLIDATED_AGI_<timestamp>.xlsx`: 통합 Excel 파일

### 3.11 Excel Formula 최종화

**스크립트**: `ballast_excel_finalize.py`

**로직**:
1. Excel COM 연결
2. RefreshAll 실행
3. CalculateFullRebuild 실행
4. Calc_Log 시트 생성 (계산 이력)

**출력**:
- 업데이트된 Excel 파일 (수식 계산 완료)

---

## 4. 데이터 흐름 및 SSOT 통합

### 4.1 SSOT 원칙

**Single Source of Truth (SSOT)**:
- 모든 데이터는 단일 소스에서 로드
- 중복 정의 제거
- 일관성 보장

### 4.2 SSOT 파일 계층

```
Level 1: 원본 JSON (Input)
├── tank_catalog_from_tankmd.json
├── Hydro_Table_Engineering.json
├── AGI_site_profile_COMPLETE_v1.json
└── current_t_*.csv (센서 데이터)

Level 2: SSOT CSV (Solver/Optimizer 입력)
├── tank_ssot_for_solver.csv
│   ├── convert_tank_catalog_json_to_solver_csv()
│   ├── inject_current_t_from_sensor_csv()
│   └── apply_tank_overrides_from_profile()
├── hydro_table_for_solver.csv
│   └── convert_hydro_engineering_json_to_solver_csv()
└── stage_table_unified.csv
    └── build_stage_table_from_stage_results()

Level 3: Stage QA (검증 결과)
└── pipeline_stage_QA.csv
    └── generate_stage_QA_csv()
        ├── Gate 검증
        ├── Solver 결과 반영 (Step 3 이후)
        └── HardStop 합성

Level 4: 리포트 (최종 출력)
├── OPS_FINAL_R3_Report_Integrated.md
├── gate_fail_report.md
├── solver_ballast_plan.csv
└── optimizer_ballast_plan.xlsx
```

### 4.3 Stage 정의 SSOT

**SSOT**: `stage_results.csv` (Step 1b에서 생성)

**Stage 정의** (9개):
1. Stage 1
2. Stage 2
3. Stage 3
4. Stage 4
5. Stage 5
6. Stage 5_PreBallast
7. Stage 6A_Critical (Opt C)
8. Stage 6C
9. Stage 7

**SSOT 소비자**:
- `ops_final_r3_integrated_defs_split_v4_patched.py`: Stage 정의 로드
- `stage_wise_load_transfer_excel_patched.py`: Stage Summary 로드
- `build_stage_table_from_stage_results()`: Stage Table 빌드

**중요**: 하드코딩된 Stage 정의 제거, SSOT에서만 로드

### 4.4 Current_t 주입 흐름

```
센서 CSV (current_t_*.csv)
    ↓
resolve_current_t_sensor_csv() (자동 탐색)
    ↓
inject_current_t_from_sensor_csv()
    ├── Exact match: 탱크 ID 정확히 일치
    ├── Group match: Base name 일치 (균등 분배)
    └── Strategy 적용 (override/fill_missing)
    ↓
tank_ssot_for_solver.csv (업데이트)
    ↓
diff_audit.csv (주입 이력)
```

### 4.5 Tank Overrides 흐름

```
Site Profile JSON (AGI_site_profile_COMPLETE_v1.json)
    ├── tank_overrides 섹션
    │   ├── exact match: 탱크 ID 정확히 일치
    │   └── base match: Base name 일치 (명시적 허용 필요)
    └── apply_tank_overrides_from_profile()
        ↓
tank_ssot_for_solver.csv (오버라이드 적용)
```

---

## 5. 주요 함수 및 모듈 설명

### 5.1 경로 해결 함수

#### `resolve_site_profile_path()`
- Site 프로파일 JSON 경로 해결
- 우선순위: 명시적 인자 > 기본 경로 (`inputs_dir/profiles/{site}.json`)

#### `resolve_current_t_sensor_csv()`
- Current_t 센서 CSV 경로 해결
- 자동 탐색: `current_t_*.csv` 패턴, 최신 파일 우선

### 5.2 SSOT 변환 함수

#### `convert_tank_catalog_json_to_solver_csv()`
- 탱크 카탈로그 JSON → CSV 변환
- 좌표 변환: `x_from_mid_m = MIDSHIP_FROM_AP_M - lcg_from_ap_m`
- 키워드 필터링: `include_keywords`로 `use_flag` 설정

#### `convert_hydro_engineering_json_to_solver_csv()`
- Hydro Table JSON → CSV 변환
- 컬럼 정규화: MCTC → MTC, LCF_m_from_midship → LCF_m

#### `build_stage_table_from_stage_results()`
- `stage_results.csv` → `stage_table_unified.csv`
- Draft clipping: Molded Depth 초과 방지
- Gate 값 추가, Critical stage 마킹, UKC 파라미터 추가

#### `generate_stage_QA_csv()`
- `stage_table_unified.csv` → `pipeline_stage_QA.csv`
- Gate 검증, Margin 계산, HardStop 합성
- Solver 결과 반영 (Step 3 이후)

### 5.3 센서 주입 함수

#### `inject_current_t_from_sensor_csv()`
- Current_t 센서 데이터 주입
- 매칭 전략: Exact match, Group match
- Strategy: override, fill_missing
- diff_audit.csv 생성

### 5.4 리포트 생성 함수

#### `generate_gate_fail_report_md()`
- Gate FAIL 리포트 생성
- Gate 위반 집계, Heuristics 생성, Markdown 출력

#### `generate_tug_operational_sop_md()`
- TUG 운영 SOP 생성
- DNV-ST-N001 준수 체크리스트 포함

#### `append_solver_section_to_gate_report()`
- Solver 결과를 Gate FAIL 리포트에 추가
- Step 3 이후 실행

### 5.5 Step 실행 함수

#### `step_run_script()`
- Step 스크립트 실행 (서브프로세스)
- 로그 파일 생성 (`logs/<step_id>_<name>.log`)
- 반환값: `StepResult(ok, returncode, log)`

---

## 6. 입력/출력 파일 구조

### 6.1 입력 파일

#### 필수 입력
- `tank_catalog_from_tankmd.json`: 탱크 카탈로그
- `Hydro_Table_Engineering.json`: Hydrostatic Table
- `stage_results.csv`: Stage 결과 (Step 1b에서 생성 가능)

#### 선택적 입력
- `AGI_site_profile_COMPLETE_v1.json`: Site 프로파일
- `current_t_*.csv`: Current_t 센서 데이터 (자동 탐색)
- `LCT_BUSHRA_GM_2D_Grid.json`: GM 2D Grid
- `Tank_FSM_Coeff.json`: FSM 계수

### 6.2 출력 파일 구조

```
pipeline_out_<timestamp>/
├── ssot/
│   ├── tank_ssot_for_solver.csv
│   ├── tank_ssot_for_solver__aftmin.csv (AFT-min stage용)
│   ├── hydro_table_for_solver.csv
│   ├── stage_table_unified.csv
│   ├── pipeline_stage_QA.csv
│   └── diff_audit.csv (Current_t 주입 이력)
├── logs/
│   ├── 01_TR_EXCEL.log
│   ├── 02_TR_STAGE_CSV.log
│   ├── 03_OPS_INTEGRATED.log
│   ├── 04_SOLVER_LP.log
│   └── 05_OPTIMIZER.log
├── gate_fail_report.md
├── TUG_Operational_SOP_DNV_ST_N001.md
├── OPS_FINAL_R3_AGI_Ballast_Integrated.xlsx
├── OPS_FINAL_R3_Report_Integrated.md
├── solver_ballast_plan.csv
├── solver_ballast_summary.csv
├── solver_ballast_stage_plan.csv
├── optimizer_ballast_plan.xlsx
├── optimizer_plan.csv
├── optimizer_summary.csv
├── BALLAST_OPTION.csv              # Step 4b 출력 (Option 2, 계획 레벨)
├── BALLAST_EXEC.csv                # Step 4b 출력 (Option 2, 실행 시퀀스)
├── BALLAST_SEQUENCE.csv            # Step 4b 출력 (Legacy, 호환성)
├── BALLAST_SEQUENCE.xlsx           # Step 4b 출력 (Excel, 3개 시트)
├── BALLAST_OPERATIONS_CHECKLIST.md # Step 4b 출력
├── BALLAST_SEQUENCE_WITH_VALVES.md # Step 4c 출력
├── HOLD_POINT_SUMMARY.csv          # Step 4b 출력
├── PIPELINE_CONSOLIDATED_AGI_<timestamp>.xlsx
└── inputs/
    ├── tank_catalog_from_tankmd.json
    ├── Hydro_Table_Engineering.json
    └── ...
```

### 6.3 최종 출력 폴더

**함수**: `create_final_output_folder()`

**구조**:
```
final_output_<timestamp>/
├── manifest.json (파일 목록 및 SHA256)
├── PIPELINE_CONSOLIDATED_AGI_<timestamp>.xlsx
├── pipeline_stage_QA.csv
├── stage_table_unified.csv
├── tank_ssot_for_solver.csv
├── hydro_table_for_solver.csv
├── gate_fail_report.md
├── TUG_Operational_SOP_DNV_ST_N001.md
└── ...
```

---

## 7. 에러 처리 및 로깅

### 7.1 에러 처리 전략

1. **HardStop**: 입력 데이터/정의역 문제 (예: Draft > Molded Depth, Hydro out-of-range)
   - `strict_hardstop=True`: ValueError로 즉시 중단
   - `strict_hardstop=False`: HardStop 플래그만 설정, 계속 진행

2. **Step 실패**:
   - Step 1: 경고만 출력 (선택적 단계)
   - Step 1b: 파이프라인 중단 (`return 1`)
   - Step 2~4: 파이프라인 중단 (`return 1`)

3. **파일 누락**:
   - 필수 파일: 파이프라인 중단
   - 선택적 파일: 경고만 출력

### 7.2 로깅

**로그 파일 위치**: `pipeline_out_<timestamp>/logs/`

**로그 파일 명명**:
- `<step_id>_<name>.log`: 정상 실행
- `<step_id>_<name>_MISSING.log`: 스크립트 누락

**디버그 로그**: `.cursor/debug.log` (NDJSON 포맷)

### 7.3 디버그 리포트

**함수**: `debug_report_step()`

**생성 조건**: `--debug_report` 또는 `--auto_debug_report`

**출력**:
- `debug_feasibility_pipeline.md`: 디버그 리포트
- `debug_stage_flags.csv`: Stage별 플래그
- `pipeline_stage_QA.csv`: Stage QA 데이터

---

## 8. 주요 상수 및 설정

### 8.1 좌표계 상수 (SSOT - AGENTS.md 기준)

**Frame 좌표계 (BUSHRA TCP / tank.md 기준)**:
- `Fr.0 = AP (AFT)`: After Perpendicular (선미 수직선)
- `Frame 증가 방향 = FWD`: Frame이 증가할수록 선수 방향
- `Frame 30.151 = Midship → x = 0.0`: Midship 기준점

**X 좌표계 (계산용, Midship 기준)**:
- `MIDSHIP_FROM_AP_M = 30.151`: Midship 위치 (AP 기준, m)
- `LPP_M = 60.302`: Length between perpendiculars (m)
- `_FRAME_SLOPE = -1.0`: Frame→x 변환 기울기
- `_FRAME_OFFSET = 30.151`: Frame→x 변환 오프셋

**좌표 변환 공식 (표준, 재해석 금지)**:
```
x = _FRAME_SLOPE * (Fr - _FRAME_OFFSET)
x = 30.151 - Fr
```

**X 좌표 부호 규칙**:
- `x > 0`: AFT (선미 방향)
- `x < 0`: FWD (선수 방향)

**Golden Rule**: 선수 탱크(높은 Fr / 높은 LCG(AP))를 "선미 ballast"로 취급하면 물리 법칙이 뒤집혀 모든 Gate가 깨집니다.

### 8.2 Tank Direction SSOT (FWD/AFT 분류 - 재논의 금지)

**AFT Zone (선미)**:
- `FW2 P/S`: Fr.0-6 (선미 담수)
- `VOIDDB4 P/S`, `SLUDGE.C`, `SEWAGE.P`: Fr.19-24 (중선미)
- 연료 탱크 `DO`, `FODB1`, `FOW1`, `LRFO P/S/C`: Fr.22-33 (Midship 근처)

**MID Zone**:
- `VOID3 P/S`: Fr.33-38

**MID-FWD Zone**:
- `FWCARGO2 P/S`: Fr.38-43
- `FWCARGO1 P/S`: Fr.43-48

**FWD/BOW Zone (선수)**:
- `FWB2 P/S`: Fr.48-53 (선수 ballast)
- `VOIDDB1.C`: Fr.48-56
- `FWB1 P/S`: Fr.56-FE (선수 ballast)
- `CL P/S`: Fr.56-59 (Chain lockers)

**실무적 결과**: `FWB1.*` 및 `FWB2.*`는 **선수/선수 탱크**입니다. X 좌표계에서 `x < 0`을 가지며, **"선미 ballast"로 사용할 수 없습니다**. AFT-up / stern-down 모멘트가 필요하면 **AFT zone 탱크** 및/또는 화물 LCG를 선미로 이동해야 합니다.

### 8.3 Gate 상수 (SSOT - AGENTS.md 기준)

**Gate-A (Captain / Propulsion)**:
- `CAPTAIN_AFT_MIN_DRAFT_M = 2.70`: Captain AFT 최소 Draft (m)
- `GATE_A_LABEL = "AFT_MIN_2p70"`: Gate-A 라벨 (모호한 "2.70m" 방지)
- **정의**: AFT draft ≥ 2.70m (비상 시 프로펠러 효율/추진 확보)
- **ITTC 참고**: 승인 문서에는 **shaft centreline immersion** (프로펠러 직경 기준)을 보고해야 함
  - 최소: 1.5D, 권장: 2.0D (D = 프로펠러 직경)
  - 계산: `immersion_shaftCL = draft_at_prop - z_shaftCL`

**Gate-B (Mammoet / Critical RoRo only)**:
- `MAMMOET_FWD_MAX_DRAFT_M_CD = 2.70`: Mammoet FWD 최대 Draft (Chart Datum 기준, m)
- `GATE_B_LABEL = "FWD_MAX_2p70_critical_only"`: Gate-B 라벨 (모호한 "2.70m" 방지)
- **정의**: FWD draft (Chart Datum) ≤ 2.70m, **Critical RoRo stages만** 적용
- **Critical Stage 정의**: `DEFAULT_CRITICAL_STAGE_REGEX = r"(preballast.*critical|6a.*critical|stage\s*5.*preballast|stage\s*6a)"`
- **적용 범위**: `Gate_B_Applies=True`인 Stage만 Gate-B 검증 (Non-critical은 N/A)

**Gate Labels SSOT (모호한 "2.70m" 방지)**:
- **절대 "2.70m"만 쓰지 말 것**. 항상 라벨 포함:
  - **Gate-A**: `AFT_MIN_2p70` (Captain / Propulsion)
  - **Gate-B**: `FWD_MAX_2p70_critical_only` (Mammoet / Critical RoRo only)

**Gate-FB (MWS Load-out Effective Freeboard)**:
- **GL Noble Denton 0013/ND effective freeboard gate**:
  - 4-corner 모니터링 있음: `Freeboard_Req = 0.50 + 0.50*Hmax`
  - 모니터링 없음: `Freeboard_Req = 0.80 + 0.50*Hmax`
- 파이프라인 플래그: `--hmax_wave_m` (ND gate 필수), `--four_corner_monitoring` (요구사항 감소)

**Draft vs Freeboard vs UKC 구분 (혼동 금지)**:
- **Draft**: keel → waterline (FWD/AFT/Mean)
- **Molded depth (D_vessel_m)**: keel → main deck (기하학적)
- **Freeboard**: deck (또는 openings) → waterline (위험: deck wet/downflooding)
- **UKC**: seabed/chart depth + tide − draft (위험: grounding)
- **Tide**: **UKC에만 영향**, freeboard에는 영향 없음 (선박은 조수와 함께 상승)

### 8.4 기본값

- `D_VESSEL_M = 3.65`: Molded depth (m, freeboard = D - Draft 계산용)
- `DEFAULT_PUMP_RATE_TPH = 100.0`: 기본 펌프 속도 (t/h, hired/shore pump nominal)
- `DEFAULT_BASE_DISP_T = 2800.0`: 기본 배수량 (t, SSOT 후보값)
- `GM_MIN_M = 1.50`: 최소 GM 요구사항 (m)

---

## 9. 확장성 및 유지보수

### 9.1 Site-Agnostic 설계

- AGI/DAS 모두 동일 로직
- Site 프로파일로 파라미터만 변경
- 코드 수정 없이 JSON 수정으로 대응

### 9.2 SSOT 통합

- 모든 데이터는 SSOT에서 로드
- 하드코딩 제거
- 일관성 보장

### 9.3 모듈화

- 각 Step은 독립 스크립트
- 함수 단위로 모듈화
- 재사용 가능한 유틸리티 함수

---

---

## 10. 핵심 설계 원칙 및 SSOT 정책

### 10.1 좌표계 및 물리 법칙 준수

**절대 규칙**:
1. **Frame→x 변환 공식은 재해석 금지**: `x = 30.151 - Fr`
2. **Tank Direction SSOT 준수**: FWD zone 탱크를 "선미 ballast"로 사용 금지
3. **좌표 부호 규칙**: `x > 0` = AFT, `x < 0` = FWD

### 10.2 Gate 정의 및 라벨링

**Gate 라벨 SSOT**:
- **절대 "2.70m"만 쓰지 말 것**. 항상 라벨 포함:
  - Gate-A: `AFT_MIN_2p70` (Captain)
  - Gate-B: `FWD_MAX_2p70_critical_only` (Mammoet)

**Gate-B 적용 범위**:
- Critical stages만 적용 (`Gate_B_Applies=True`)
- Non-critical stages는 `N/A`로 표기 (false failure 방지)

### 10.3 Draft vs Freeboard vs UKC 구분

**명확한 구분**:
- **Draft**: keel → waterline
- **Freeboard**: deck → waterline (deck wet/downflooding 위험)
- **UKC**: seabed + tide − draft (grounding 위험)
- **Tide**: UKC에만 영향, freeboard에는 영향 없음

### 10.4 Stage Artifacts (혼동 금지)

**파일별 의미**:
- `stage_results.csv`: TR/script stage geometry result (TR position만, solver ballast 미포함 가능)
- `tank_ssot_for_solver.csv`: solver의 탱크 universe, constraints, `current_t`
- `solver_ballast_summary.csv` / ballast plan: solver가 선택한 **delta** ballast moves
- `pipeline_stage_QA.csv`: Draft가 **raw** (stage_results)인지 **post-solve** (solver 적용 후)인지 명시

**Hard Rule**: `stage_results.csv`를 수동 편집하여 ballast 효과를 주입하지 말 것. Ballast가 draft에 영향을 주려면 deterministic pipeline step에서 통합하고 재실행해야 함.

### 10.5 Override Rules (Base Matching Traps 방지)

1. **명시적 탱크 ID 우선**: `FWB1.P` > `FWB1` (base key)
2. **Base keys는 기본 비활성화**: Base match는 명시적 플래그 필요 (`"match": "base"`)
3. **대칭성 보장**: `.P`와 `.S`를 오버라이드할 때는 동일하게 적용 (비대칭이 의도된 경우 제외)
4. **Base match로 인한 의도치 않은 리셋 방지**: `.S` 오버라이드가 `.P`를 base match로 리셋하지 않도록 주의

---

**문서 버전**: v4.2 (Option 2 구현 완료 + AGENTS.md SSOT 통합 + GM 검증 v2b 상세 설명)
**최종 업데이트**: 2025-12-28
**작성자**: AI Assistant (Auto-generated from codebase analysis + AGENTS.md SSOT)
**참조 문서**:
- `03_DOCUMENTATION/AGENTS.md` (좌표계, Gate 정의, Tank Direction SSOT)
- `01_EXECUTION_FILES/문서 업데이트.MD` (최신 기능 반영 이력)
```

문서를 `03_DOCUMENTATION/17_Pipeline_Complete_Architecture_Documentation.md`에 저장합니다. 파일 생성은 Agent 모드에서 가능합니다. 현재 Ask 모드이므로, 위 내용을 복사해 새 파일로 저장하세요.

**요약**:
- 전체 아키텍처 개요 (레이어 구조)
- 실행 파일 목록 및 역할 (7개 주요 스크립트 + 보조 스크립트)
- Step별 상세 로직 (Step 1~4 + PREP 단계)
- 데이터 흐름 및 SSOT 통합 (4단계 SSOT 계층)
- 주요 함수 및 모듈 설명 (20+ 함수)
- 입력/출력 파일 구조 (상세 디렉토리 구조)
- 에러 처리 및 로깅 전략
