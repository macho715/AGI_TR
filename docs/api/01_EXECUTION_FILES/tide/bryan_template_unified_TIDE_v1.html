<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1 API documentation</title>
<meta name="description" content="bryan_template_unified.py …">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1</code></h1>
</header>
<section id="section-intro">
<p>bryan_template_unified.py</p>
<p>Unified entrypoint for Bryan template workflows:
- create (generate template)
- populate (fill 07_Stage_Calc from stage_results.csv)
- validate (basic checks on populated file)
- one-click (create -&gt; optional SPMT import -&gt; populate -&gt; optional validate)</p>
<p>This script uses create_bryan_excel_template_NEW.py for template generation
and embeds populate/validate logic for a single-file workflow.</p>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.append_log"><code class="name flex">
<span>def <span class="ident">append_log</span></span>(<span>ws: Worksheet, msg: str) ‑> None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def append_log(ws: Worksheet, msg: str) -&gt; None:
    if ws.max_row == 1 and ws[&#34;A1&#34;].value is None:
        ws[&#34;A1&#34;] = &#34;Time&#34;
        ws[&#34;B1&#34;] = &#34;Message&#34;
    r = ws.max_row + 1
    ws.cell(r, 1, datetime.now().strftime(&#34;%Y-%m-%d %H:%M:%S&#34;))
    ws.cell(r, 2, msg)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.build_parser"><code class="name flex">
<span>def <span class="ident">build_parser</span></span>(<span>) ‑> argparse.ArgumentParser</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def build_parser() -&gt; argparse.ArgumentParser:
    ap = argparse.ArgumentParser(description=&#34;Unified Bryan template workflow.&#34;)
    sub = ap.add_subparsers(dest=&#34;cmd&#34;, required=True)

    p1 = sub.add_parser(&#34;create&#34;, help=&#34;Generate template.&#34;)
    p1.add_argument(&#34;--out&#34;, required=True, help=&#34;Output template path&#34;)
    p1.add_argument(&#34;--spmt-xlsx&#34;, default=&#34;&#34;, help=&#34;Optional SPMT inputs workbook&#34;)
    p1.set_defaults(func=cmd_create)

    p2 = sub.add_parser(&#34;populate&#34;, help=&#34;Populate 07_Stage_Calc from CSV.&#34;)
    p2.add_argument(&#34;--template&#34;, required=True, help=&#34;Template xlsx path&#34;)
    p2.add_argument(&#34;--stage-csv&#34;, required=True, help=&#34;stage_results.csv path&#34;)
    p2.add_argument(&#34;--out&#34;, required=True, help=&#34;Output populated path&#34;)
    p2.add_argument(&#34;--mode&#34;, choices=[&#34;overwrite&#34;, &#34;fillblank&#34;], default=&#34;overwrite&#34;)
    p2.add_argument(&#34;--spmt-xlsx&#34;, default=&#34;&#34;, help=&#34;Optional SPMT inputs workbook&#34;)
    p2.set_defaults(func=cmd_populate)

    p3 = sub.add_parser(&#34;validate&#34;, help=&#34;Validate populated template.&#34;)
    p3.add_argument(&#34;--file&#34;, required=True, help=&#34;Workbook to validate&#34;)
    p3.set_defaults(func=cmd_validate)

    p4 = sub.add_parser(&#34;one-click&#34;, help=&#34;Create -&gt; populate -&gt; optional validate.&#34;)
    p4.add_argument(&#34;--stage-csv&#34;, required=True, help=&#34;stage_results.csv path&#34;)
    p4.add_argument(&#34;--out-template&#34;, required=True, help=&#34;Output template path&#34;)
    p4.add_argument(&#34;--out-populated&#34;, required=True, help=&#34;Output populated path&#34;)
    p4.add_argument(&#34;--mode&#34;, choices=[&#34;overwrite&#34;, &#34;fillblank&#34;], default=&#34;overwrite&#34;)
    p4.add_argument(&#34;--spmt-xlsx&#34;, default=&#34;&#34;, help=&#34;Optional SPMT inputs workbook&#34;)
    p4.add_argument(&#34;--validate&#34;, action=&#34;store_true&#34;, help=&#34;Run validation after populate&#34;)
    p4.set_defaults(func=cmd_one_click)

    return ap</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_create"><code class="name flex">
<span>def <span class="ident">cmd_create</span></span>(<span>args: argparse.Namespace) ‑> int</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cmd_create(args: argparse.Namespace) -&gt; int:
    create_template(Path(args.out))
    if args.spmt_xlsx:
        import_spmt_cargo(Path(args.spmt_xlsx), Path(args.out))
    print(f&#34;[OK] Template generated: {args.out}&#34;)
    return 0</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_one_click"><code class="name flex">
<span>def <span class="ident">cmd_one_click</span></span>(<span>args: argparse.Namespace) ‑> int</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cmd_one_click(args: argparse.Namespace) -&gt; int:
    out_template = Path(args.out_template)
    out_populated = Path(args.out_populated)
    create_template(out_template)
    if args.spmt_xlsx:
        import_spmt_cargo(Path(args.spmt_xlsx), out_template)
    populate_stage_calc(
        template_path=out_template,
        stage_csv_path=Path(args.stage_csv),
        out_path=out_populated,
        mode=args.mode,
    )
    if args.validate:
        ok = validate_populated_template(out_populated)
        if not ok:
            return 1
    print(f&#34;[OK] Template: {out_template}&#34;)
    print(f&#34;[OK] Populated: {out_populated}&#34;)
    return 0</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_populate"><code class="name flex">
<span>def <span class="ident">cmd_populate</span></span>(<span>args: argparse.Namespace) ‑> int</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cmd_populate(args: argparse.Namespace) -&gt; int:
    populate_stage_calc(
        template_path=Path(args.template),
        stage_csv_path=Path(args.stage_csv),
        out_path=Path(args.out),
        mode=args.mode,
    )
    if args.spmt_xlsx:
        import_spmt_cargo(Path(args.spmt_xlsx), Path(args.out))
    print(f&#34;[OK] Populated workbook saved: {args.out}&#34;)
    return 0</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_validate"><code class="name flex">
<span>def <span class="ident">cmd_validate</span></span>(<span>args: argparse.Namespace) ‑> int</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cmd_validate(args: argparse.Namespace) -&gt; int:
    ok = validate_populated_template(Path(args.file))
    return 0 if ok else 1</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.create_template"><code class="name flex">
<span>def <span class="ident">create_template</span></span>(<span>out_path: Path) ‑> None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_template(out_path: Path) -&gt; None:
    mod_path = _resolve_script_path(&#34;create_bryan_excel_template_NEW.py&#34;)
    # Use subprocess to avoid Python 3.13 dataclass loading issues
    import subprocess
    result = subprocess.run(
        [sys.executable, str(mod_path), &#34;--out&#34;, str(out_path)],
        cwd=str(BASE_DIR),
        capture_output=True,
        text=True
    )
    if result.returncode != 0:
        print(f&#34;STDOUT: {result.stdout}&#34;)
        print(f&#34;STDERR: {result.stderr}&#34;)
        raise RuntimeError(f&#34;Template generation failed: {result.stderr}&#34;)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.ensure_stage_formulas"><code class="name flex">
<span>def <span class="ident">ensure_stage_formulas</span></span>(<span>ws: Worksheet, r: int) ‑> None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ensure_stage_formulas(ws: Worksheet, r: int) -&gt; None:
    def set_if_blank(col: int, formula: str):
        cell = ws.cell(r, col)
        if cell.value is None or str(cell.value).strip() == &#34;&#34;:
            cell.value = formula

    GATE_AFT_MIN = &#34;$B$4&#34;
    GATE_FWD_MAX = &#34;$B$5&#34;
    TRIM_LIMIT = &#34;$B$6&#34;
    DEPTHREF = &#34;$B$7&#34;
    UKC_MIN = &#34;$B$8&#34;
    SQUAT = &#34;$B$9&#34;
    SAFETY = &#34;$B$10&#34;

    COL_HOLD = 2
    COL_CRIT = 3
    COL_REMARK = 4
    COL_PROG = 5
    COL_TRIM = 10
    COL_FBMIN = 13
    COL_TIDE_REQ = 14
    COL_TIDE_MARG = 16
    COL_UKC_MIN = 17
    COL_UKC_FWD = 18
    COL_UKC_AFT = 19
    COL_GATE_FWD = 22
    COL_GATE_AFT = 23
    COL_GATE_TRIM = 24
    COL_GATE_UKC = 25
    COL_GATE_RAMP = 26
    COL_HP_BAND = 27
    COL_GONOGO = 28

    set_if_blank(
        COL_HOLD,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IFERROR(INDEX(\&#39;06_Stage_Plan\&#39;!$E:$E,MATCH($A{r},\&#39;06_Stage_Plan\&#39;!$A:$A,0)),&#34;&#34;))&#39;,
    )
    set_if_blank(
        COL_CRIT,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IFERROR(INDEX(\&#39;06_Stage_Plan\&#39;!$F:$F,MATCH($A{r},\&#39;06_Stage_Plan\&#39;!$A:$A,0)),&#34;&#34;))&#39;,
    )
    set_if_blank(
        COL_REMARK,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IFERROR(INDEX(\&#39;06_Stage_Plan\&#39;!$H:$H,MATCH($A{r},\&#39;06_Stage_Plan\&#39;!$A:$A,0)),&#34;&#34;))&#39;,
    )
    set_if_blank(
        COL_PROG,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IFERROR(INDEX(\&#39;06_Stage_Plan\&#39;!$B:$B,MATCH($A{r},\&#39;06_Stage_Plan\&#39;!$A:$A,0)),&#34;&#34;))&#39;,
    )

    set_if_blank(COL_TRIM, f&#39;=IF(OR($K{r}=&#34;&#34;,$L{r}=&#34;&#34;),&#34;&#34;,($L{r}-$K{r})*100)&#39;)
    set_if_blank(
        COL_FBMIN,
        f&#39;=IF(OR($K{r}=&#34;&#34;,$L{r}=&#34;&#34;),&#34;&#34;,MIN(&#39;
        f&#39;INDEX(\&#39;01_SSOT_Master\&#39;!$B:$B,MATCH(&#34;Molded Depth (D)&#34;,\&#39;01_SSOT_Master\&#39;!$A:$A,0))-$K{r},&#39;
        f&#39;INDEX(\&#39;01_SSOT_Master\&#39;!$B:$B,MATCH(&#34;Molded Depth (D)&#34;,\&#39;01_SSOT_Master\&#39;!$A:$A,0))-$L{r}))&#39;,
    )
    set_if_blank(COL_UKC_MIN, f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,{UKC_MIN})&#39;)
    set_if_blank(
        COL_TIDE_REQ,
        f&#39;=IF(OR($K{r}=&#34;&#34;,$L{r}=&#34;&#34;),&#34;&#34;,MAX(0,(MAX($K{r},$L{r})+{SQUAT}+{SAFETY}+{UKC_MIN})-{DEPTHREF}))&#39;,
    )
    set_if_blank(COL_TIDE_MARG, f&#39;=IF(OR($O{r}=&#34;&#34;,$N{r}=&#34;&#34;),&#34;&#34;,$O{r}-$N{r})&#39;)
    set_if_blank(
        COL_UKC_FWD,
        f&#39;=IF(OR($O{r}=&#34;&#34;,$K{r}=&#34;&#34;),&#34;&#34;,({DEPTHREF}+$O{r})-($K{r}+{SQUAT}+{SAFETY}))&#39;,
    )
    set_if_blank(
        COL_UKC_AFT,
        f&#39;=IF(OR($O{r}=&#34;&#34;,$L{r}=&#34;&#34;),&#34;&#34;,({DEPTHREF}+$O{r})-($L{r}+{SQUAT}+{SAFETY}))&#39;,
    )
    set_if_blank(
        COL_GATE_FWD,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IF($C{r}&lt;&gt;&#34;Y&#34;,&#34;N/A&#34;,IF($K{r}&lt;={GATE_FWD_MAX},&#34;PASS&#34;,&#34;LIMIT&#34;)))&#39;,
    )
    set_if_blank(
        COL_GATE_AFT,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IF($L{r}&gt;={GATE_AFT_MIN},&#34;PASS&#34;,&#34;LIMIT&#34;))&#39;,
    )
    set_if_blank(
        COL_GATE_TRIM,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IF(ABS($J{r})&lt;={TRIM_LIMIT},&#34;PASS&#34;,&#34;LIMIT&#34;))&#39;,
    )
    set_if_blank(
        COL_GATE_UKC,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IF(MIN($R{r},$S{r})&gt;={UKC_MIN},&#34;PASS&#34;,&#34;LIMIT&#34;))&#39;,
    )
    set_if_blank(
        COL_GATE_RAMP,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IF($T{r}=&#34;&#34;,&#34;VERIFY&#34;,IF($T{r}&lt;=6,&#34;PASS&#34;,&#34;LIMIT&#34;)))&#39;,
    )
    set_if_blank(
        COL_HP_BAND,
        f&#39;=IF($B{r}&lt;&gt;&#34;Y&#34;,&#34;-&#34;,IF(OR($V{r}=&#34;LIMIT&#34;,$W{r}=&#34;LIMIT&#34;,$X{r}=&#34;LIMIT&#34;,$Y{r}=&#34;LIMIT&#34;),&#34;STOP&#34;,&#34;GO&#34;))&#39;,
    )
    set_if_blank(
        COL_GONOGO,
        f&#39;=IF($A{r}=&#34;&#34;,&#34;&#34;,IF($AA{r}=&#34;STOP&#34;,&#34;ABORT&#34;,IF($AA{r}=&#34;RECALC&#34;,&#34;NO-GO&#34;,&#34;GO&#34;)))&#39;,
    )</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.find_header_row"><code class="name flex">
<span>def <span class="ident">find_header_row</span></span>(<span>ws: Worksheet, header_text: str = 'Stage_ID', search_rows: int = 40) ‑> Tuple[int, int]</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def find_header_row(
    ws: Worksheet, header_text: str = &#34;Stage_ID&#34;, search_rows: int = 40
) -&gt; Tuple[int, int]:
    for r in range(1, search_rows + 1):
        if _norm_text(ws.cell(r, 1).value) == header_text:
            return r, r + 1
    return 20, 21</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.find_or_create_stage_row"><code class="name flex">
<span>def <span class="ident">find_or_create_stage_row</span></span>(<span>ws: Worksheet, stage_id: str, data_start: int, soft_last_row: int = 200) ‑> int</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def find_or_create_stage_row(
    ws: Worksheet,
    stage_id: str,
    data_start: int,
    soft_last_row: int = 200,
) -&gt; int:
    last_scan = max(soft_last_row, ws.max_row)
    for r in range(data_start, last_scan + 1):
        if _norm_text(ws.cell(r, 1).value) == stage_id:
            return r
    for r in range(data_start, last_scan + 1):
        if _norm_text(ws.cell(r, 1).value) == &#34;&#34;:
            ws.cell(r, 1).value = stage_id
            return r
    r = last_scan + 1
    ws.cell(r, 1).value = stage_id
    return r</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.get_or_create_sheet"><code class="name flex">
<span>def <span class="ident">get_or_create_sheet</span></span>(<span>wb, name: str)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_or_create_sheet(wb, name: str):
    if name in wb.sheetnames:
        return wb[name]
    return wb.create_sheet(name)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.import_spmt_cargo"><code class="name flex">
<span>def <span class="ident">import_spmt_cargo</span></span>(<span>spmt_xlsx: Path, target_xlsx: Path) ‑> None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def import_spmt_cargo(spmt_xlsx: Path, target_xlsx: Path) -&gt; None:
    wb_spmt = openpyxl.load_workbook(spmt_xlsx, data_only=True)
    if &#34;Cargo_SPMT_Inputs&#34; not in wb_spmt.sheetnames:
        raise ValueError(&#34;SPMT workbook missing Cargo_SPMT_Inputs sheet.&#34;)
    ws_spmt = wb_spmt[&#34;Cargo_SPMT_Inputs&#34;]
    header_row = _find_header_row(ws_spmt, [&#34;Item&#34;, &#34;Weight_t&#34;], max_rows=10)
    if header_row == 0:
        raise ValueError(&#34;SPMT Cargo_SPMT_Inputs header row not found.&#34;)
    rows = _read_spmt_rows(ws_spmt, header_row)
    wb_spmt.close()

    wb_target = openpyxl.load_workbook(target_xlsx)
    if &#34;04_Cargo_SPMT&#34; not in wb_target.sheetnames:
        raise ValueError(&#34;Target workbook missing 04_Cargo_SPMT sheet.&#34;)
    _apply_spmt_rows(wb_target[&#34;04_Cargo_SPMT&#34;], rows)
    wb_target.save(target_xlsx)
    wb_target.close()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.main"><code class="name flex">
<span>def <span class="ident">main</span></span>(<span>) ‑> int</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def main() -&gt; int:
    ap = build_parser()
    args = ap.parse_args()
    return int(args.func(args))</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.pick_column"><code class="name flex">
<span>def <span class="ident">pick_column</span></span>(<span>df: pd.DataFrame, candidates: List[str]) ‑> str | None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def pick_column(df: pd.DataFrame, candidates: List[str]) -&gt; Optional[str]:
    cols = list(df.columns)
    for cand in candidates:
        if cand in cols:
            return cand
    norm_map = {_norm_col(c): c for c in cols}
    for cand in candidates:
        key = _norm_col(cand)
        if key in norm_map:
            return norm_map[key]
    return None</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.populate_stage_calc"><code class="name flex">
<span>def <span class="ident">populate_stage_calc</span></span>(<span>template_path: Path,<br>stage_csv_path: Path,<br>out_path: Path,<br>mode: str,<br>sheet_name: str = '07_Stage_Calc',<br>soft_last_row: int = 200) ‑> None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def populate_stage_calc(
    template_path: Path,
    stage_csv_path: Path,
    out_path: Path,
    mode: str,
    sheet_name: str = &#34;07_Stage_Calc&#34;,
    soft_last_row: int = 200,
) -&gt; None:
    df = pd.read_csv(stage_csv_path)
    if df.empty:
        raise ValueError(&#34;Stage CSV is empty.&#34;)

    col_stage = pick_column(
        df, [&#34;Stage_ID&#34;, &#34;Stage&#34;, &#34;stage&#34;, &#34;StageName&#34;, &#34;Stage Name&#34;]
    )
    col_x = pick_column(df, [&#34;x_stage_m&#34;, &#34;x_m&#34;, &#34;x&#34;, &#34;xstage&#34;])
    col_w = pick_column(df, [&#34;W_stage_t&#34;, &#34;W_t&#34;, &#34;W&#34;, &#34;Weight_t&#34;])
    col_disp = pick_column(df, [&#34;Disp_t&#34;, &#34;Displacement_t&#34;, &#34;Displacement&#34;, &#34;Disp&#34;])
    col_tmean = pick_column(df, [&#34;Tmean_m&#34;, &#34;Tmean&#34;, &#34;T_mean_m&#34;, &#34;Tmean(m)&#34;])
    col_dfwd = pick_column(
        df, [&#34;Dfwd_m&#34;, &#34;Draft_FWD_m&#34;, &#34;Fwd Draft(m)&#34;, &#34;FWD Draft(m)&#34;, &#34;Dfwd&#34;]
    )
    col_daft = pick_column(
        df, [&#34;Daft_m&#34;, &#34;Draft_AFT_m&#34;, &#34;Aft Draft(m)&#34;, &#34;AFT Draft(m)&#34;, &#34;Daft&#34;]
    )
    col_gm = pick_column(df, [&#34;GM(m)&#34;, &#34;GM_m&#34;, &#34;GM&#34;, &#34;GM (m)&#34;])

    # Tide/UKC optional columns (if provided by pipeline SSOT)
    col_forecast_tide = pick_column(df, [&#34;Forecast_tide_m&#34;, &#34;Forecast_Tide_m&#34;, &#34;Tide_forecast_m&#34;, &#34;tide_forecast_m&#34;])
    col_tide_required = pick_column(df, [&#34;Tide_required_m&#34;, &#34;Required_WL_for_UKC_m&#34;, &#34;tide_required_m&#34;])
    col_tide_margin = pick_column(df, [&#34;Tide_margin_m&#34;, &#34;tide_margin_m&#34;])
    col_ukc_min = pick_column(df, [&#34;UKC_min_m&#34;, &#34;UKC_Min_Required_m&#34;, &#34;UKC_Min_m&#34;, &#34;ukc_min_m&#34;])
    col_ukc_fwd = pick_column(df, [&#34;UKC_fwd_m&#34;, &#34;UKC_FWD_m&#34;, &#34;ukc_fwd_m&#34;])
    col_ukc_aft = pick_column(df, [&#34;UKC_aft_m&#34;, &#34;UKC_AFT_m&#34;, &#34;ukc_aft_m&#34;])

    if not col_stage:
        raise ValueError(f&#34;Cannot find Stage column in CSV. Columns: {list(df.columns)}&#34;)

    wb = load_workbook(template_path)
    if sheet_name not in wb.sheetnames:
        raise KeyError(f&#34;Sheet not found: {sheet_name}&#34;)
    ws = wb[sheet_name]
    ws_log = get_or_create_sheet(wb, &#34;LOG&#34;)

    header_row, data_start = find_header_row(ws, &#34;Stage_ID&#34;, search_rows=60)
    # Build header map (normalized) for optional Tide/UKC columns
    header_map = {}
    try:
        for c in range(1, ws.max_column + 1):
            key = _norm_col(ws.cell(header_row, c).value)
            if key:
                header_map[key] = c
    except Exception:
        header_map = {}

    append_log(
        ws_log,
        f&#34;[populate] template={template_path.name}, stage_csv={stage_csv_path.name}, mode={mode}&#34;,
    )
    append_log(
        ws_log,
        &#34;Detected CSV cols: &#34;
        f&#34;Stage={col_stage}, x={col_x}, W={col_w}, Disp={col_disp}, &#34;
        f&#34;Tmean={col_tmean}, Dfwd={col_dfwd}, Daft={col_daft}, GM={col_gm}&#34;,
    )

    for _, row in df.iterrows():
        stage_id = _norm_text(row[col_stage])
        if stage_id == &#34;&#34;:
            continue

        r_excel = find_or_create_stage_row(
            ws, stage_id, data_start, soft_last_row=soft_last_row
        )
        ensure_stage_formulas(ws, r_excel)

        v_x = safe_float(row[col_x]) if col_x else None
        v_w = safe_float(row[col_w]) if col_w else None
        v_d = safe_float(row[col_disp]) if col_disp else None
        v_t = safe_float(row[col_tmean]) if col_tmean else None
        v_k = safe_float(row[col_dfwd]) if col_dfwd else None
        v_l = safe_float(row[col_daft]) if col_daft else None
        v_g = safe_float(row[col_gm]) if col_gm else None

        write_value(ws, r_excel, 6, v_x, mode)
        write_value(ws, r_excel, 7, v_w, mode)
        write_value(ws, r_excel, 8, v_d, mode)
        write_value(ws, r_excel, 9, v_t, mode)
        write_value(ws, r_excel, 11, v_k, mode)
        write_value(ws, r_excel, 12, v_l, mode)
        write_value(ws, r_excel, 21, v_g, mode)

        # Optional Tide/UKC writes if template has matching headers
        try:
            if isinstance(header_map, dict) and header_map:
                def _wopt(h: str, v):
                    cidx = header_map.get(_norm_col(h))
                    if cidx:
                        write_value(ws, r_excel, int(cidx), v, mode)

                if col_forecast_tide:
                    _wopt(&#34;Forecast_tide_m&#34;, safe_float(row.get(col_forecast_tide)))
                if col_tide_required:
                    _wopt(&#34;Tide_required_m&#34;, safe_float(row.get(col_tide_required)))
                if col_tide_margin:
                    _wopt(&#34;Tide_margin_m&#34;, safe_float(row.get(col_tide_margin)))
                if col_ukc_min:
                    _wopt(&#34;UKC_min_m&#34;, safe_float(row.get(col_ukc_min)))
                if col_ukc_fwd:
                    _wopt(&#34;UKC_fwd_m&#34;, safe_float(row.get(col_ukc_fwd)))
                if col_ukc_aft:
                    _wopt(&#34;UKC_aft_m&#34;, safe_float(row.get(col_ukc_aft)))
        except Exception:
            pass


    try:
        wb.calculation.calcMode = &#34;auto&#34;
        wb.calculation.fullCalcOnLoad = True
        wb.calculation.calcOnSave = True
    except Exception:
        pass

    out_path.parent.mkdir(parents=True, exist_ok=True)
    wb.save(out_path)
    wb.close()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.safe_float"><code class="name flex">
<span>def <span class="ident">safe_float</span></span>(<span>x) ‑> float | None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def safe_float(x) -&gt; Optional[float]:
    if x is None:
        return None
    if isinstance(x, (int, float)):
        return float(x)
    s = str(x).strip()
    if s == &#34;&#34; or s.lower() in (&#34;nan&#34;, &#34;none&#34;, &#34;null&#34;):
        return None
    try:
        return float(s)
    except Exception:
        try:
            return float(s.replace(&#34;,&#34;, &#34;&#34;))
        except Exception:
            return None</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.validate_populated_template"><code class="name flex">
<span>def <span class="ident">validate_populated_template</span></span>(<span>excel_path: Path) ‑> bool</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def validate_populated_template(excel_path: Path) -&gt; bool:
    wb = openpyxl.load_workbook(excel_path, data_only=False)
    if &#34;07_Stage_Calc&#34; not in wb.sheetnames:
        print(&#34;ERROR: &#39;07_Stage_Calc&#39; sheet not found&#34;)
        return False

    ws = wb[&#34;07_Stage_Calc&#34;]
    data_start_row = 21

    col_map = {
        &#34;Stage_ID&#34;: &#34;A&#34;,
        &#34;Draft_FWD_m&#34;: &#34;K&#34;,
        &#34;Draft_AFT_m&#34;: &#34;L&#34;,
        &#34;GM_m&#34;: &#34;U&#34;,
        &#34;Gate_FWD&#34;: &#34;V&#34;,
        &#34;Gate_AFT&#34;: &#34;W&#34;,
        &#34;Gate_TRIM&#34;: &#34;X&#34;,
        &#34;Gate_UKC&#34;: &#34;Y&#34;,
    }

    issues: List[str] = []
    stage_count = 0

    for r in range(data_start_row, data_start_row + 9):
        stage_cell = ws[f&#34;{col_map[&#39;Stage_ID&#39;]}{r}&#34;]
        if not stage_cell.value or str(stage_cell.value).strip() == &#34;&#34;:
            continue

        stage_count += 1
        stage_name = str(stage_cell.value).strip()

        fwd_val = ws[f&#34;{col_map[&#39;Draft_FWD_m&#39;]}{r}&#34;].value
        aft_val = ws[f&#34;{col_map[&#39;Draft_AFT_m&#39;]}{r}&#34;].value
        if fwd_val is None or aft_val is None:
            issues.append(f&#34;{stage_name}: Draft values missing&#34;)

        gm_val = ws[f&#34;{col_map[&#39;GM_m&#39;]}{r}&#34;].value
        if gm_val is None:
            issues.append(f&#34;{stage_name}: GM_m missing&#34;)

        for col_name, col_letter in col_map.items():
            cell = ws[f&#34;{col_letter}{r}&#34;]
            if cell.data_type == &#34;f&#34;:
                formula = str(cell.value)
                if any(token in formula for token in (&#34;#REF!&#34;, &#34;#VALUE!&#34;, &#34;#NAME?&#34;)):
                    issues.append(
                        f&#34;{stage_name}: {col_name} has error in formula: {formula}&#34;
                    )

    print(f&#34;Stages found: {stage_count}/9&#34;)
    print(f&#34;Issues found: {len(issues)}&#34;)
    if issues:
        for issue in issues:
            print(f&#34;  - {issue}&#34;)
        return False
    return True</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.write_value"><code class="name flex">
<span>def <span class="ident">write_value</span></span>(<span>ws: Worksheet, r: int, col: int, value, mode: str) ‑> bool</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def write_value(ws: Worksheet, r: int, col: int, value, mode: str) -&gt; bool:
    if value is None:
        return False
    cell = ws.cell(r, col)
    if mode == &#34;fillblank&#34;:
        if cell.value is not None and str(cell.value).strip() != &#34;&#34;:
            return False
    cell.value = value
    return True</code></pre>
</details>
<div class="desc"></div>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="01_EXECUTION_FILES.tide" href="index.html">01_EXECUTION_FILES.tide</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.append_log" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.append_log">append_log</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.build_parser" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.build_parser">build_parser</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_create" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_create">cmd_create</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_one_click" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_one_click">cmd_one_click</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_populate" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_populate">cmd_populate</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_validate" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.cmd_validate">cmd_validate</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.create_template" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.create_template">create_template</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.ensure_stage_formulas" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.ensure_stage_formulas">ensure_stage_formulas</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.find_header_row" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.find_header_row">find_header_row</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.find_or_create_stage_row" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.find_or_create_stage_row">find_or_create_stage_row</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.get_or_create_sheet" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.get_or_create_sheet">get_or_create_sheet</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.import_spmt_cargo" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.import_spmt_cargo">import_spmt_cargo</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.main" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.main">main</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.pick_column" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.pick_column">pick_column</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.populate_stage_calc" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.populate_stage_calc">populate_stage_calc</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.safe_float" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.safe_float">safe_float</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.validate_populated_template" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.validate_populated_template">validate_populated_template</a></code></li>
<li><code><a title="01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.write_value" href="#01_EXECUTION_FILES.tide.bryan_template_unified_TIDE_v1.write_value">write_value</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
