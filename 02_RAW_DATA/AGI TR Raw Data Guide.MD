AGI TR Raw Data Guide

**Version**: v1.0
**Last Updated**: 2025-12-30
**Purpose**: Comprehensive guide for all raw data files in `AGI TR/02_RAW_DATA/`
**Target Audience**: Developers, operators, data engineers

---

## Table of Contents

1. [Overview](#1-overview)
2. [Folder Structure](#2-folder-structure)
3. [Root Level Files](#3-root-level-files)
4. [Subdirectories](#4-subdirectories)
5. [Data Flow and SSOT Conversion](#5-data-flow-and-ssot-conversion)
6. [Usage Guidelines](#6-usage-guidelines)
7. [Data Validation](#7-data-validation)
8. [Troubleshooting](#8-troubleshooting)

---

## 1. Overview

### 1.1 Purpose

The `02_RAW_DATA/` folder contains all **source data files** used by the Ballast Pipeline system. These files serve as the **Single Source of Truth (SSOT)** for:

- Tank catalog and properties
- Hydrostatic table data
- Stage definitions and calculations
- Site-specific profiles and configurations
- Sensor measurements (current tank levels)
- Additional operational criteria

### 1.2 Data Hierarchy

```
Level 1: Raw Data (02_RAW_DATA/)
├── Original JSON/CSV files
├── Sensor measurements
└── Site profiles

Level 2: SSOT CSV (Generated by pipeline)
├── tank_ssot_for_solver.csv
├── hydro_table_for_solver.csv
└── stage_table_unified.csv

Level 3: Processed Results
└── pipeline_stage_QA.csv
```

### 1.3 Key Principles

- **Single Source of Truth**: Each data element has one authoritative source
- **No Duplication**: Data is not duplicated across files
- **Consistency**: All pipeline steps read from the same source files
- **Traceability**: All data transformations are logged and auditable

---

## 2. Folder Structure

```
AGI TR/02_RAW_DATA/
├── stage_results.csv                    # Stage definitions and calculations
├── tank_catalog_from_tankmd.json       # Tank catalog (SSOT)
├── Frame_x_from_mid_m.json             # Frame ↔ x coordinate conversion
├── LCT_BUSHRA_GM_2D_Grid.json         # GM 2D interpolation grid
├── profiles/                            # Site-specific profiles
│   ├── AGI_site_profile_COMPLETE_v1.json
│   ├── AGI.json
│   └── site_profile_AGI_*.json
├── sensors/                             # Sensor measurements
│   └── current_t_sensor.csv
├── additional_inputs/                   # Operational criteria
│   ├── Acceptance_Criteria.json
│   ├── GM_Min_Curve.json
│   ├── ISCODE_Criteria.json
│   ├── Securing_Input.json
│   └── Structural_Limits.json
└── bplus_inputs/                        # B+ system inputs
    └── Hydro_Table_Engineering.json
```

---

## 3. Root Level Files

### 3.1 `stage_results.csv`

**Purpose**: Stage definitions and initial calculations (SSOT for stages)

**Generated By**: Step 1b (`agi_tr_patched_v6_6_defsplit_v1.py`)

**Schema**:

```csv
Stage,W_stage_t,x_stage_m,TM_LCF_tm,Trim_cm,Dfwd_m,Daft_m,GM(m),Fwd Draft(m),FWD_Height_m,AFT_Height_m,Trim_Check,vs_2.70m,GM_Check,Disp_t,Tmean_m,PreBallast_t
```

**Key Columns**:

- `Stage`: Stage identifier (e.g., "Stage 1", "Stage 5_PreBallast")
- `W_stage_t`: Stage weight (tonnes)
- `Dfwd_m`, `Daft_m`: Forward and aft drafts (meters)
- `GM(m)`: Metacentric height (meters)
- `Disp_t`: Displacement (tonnes)
- `Tmean_m`: Mean draft (meters)

**Stage Definitions** (9 stages):

1. Stage 1
2. Stage 2
3. Stage 3
4. Stage 4
5. Stage 5
6. Stage 5_PreBallast
7. Stage 6A_Critical (Opt C)
8. Stage 6C
9. Stage 7

**Usage**:

- Loaded by `ops_final_r3_integrated_defs_split_v4_patched_TIDE_v1.py`
- Used to build `stage_table_unified.csv`
- Referenced by all pipeline steps for stage definitions

**Important**: This file is the **SSOT for stage definitions**. Do not hardcode stage names elsewhere.

---

### 3.2 `tank_catalog_from_tankmd.json`

**Purpose**: Complete tank catalog with properties (SSOT for tanks)

**Source**: `tank.md` (converted to JSON)

**Schema**:

```json
{
  "schema": "tank_catalog.v1",
  "generated_at": "2025-12-16T05:44:25",
  "source_file": "tank.md",
  "assumptions": [...],
  "tanks": [
    {
      "id": "DO.P",
      "category": "fuel_oil",
      "loc": "Fr24-25",
      "fr_start": 24,
      "fr_end": 25,
      "cap_t": 3.05,
      "lcg_m": 11.251,
      "tcg_m": 6.247,
      "tcg_side": "port",
      "vcg_m": 2.825,
      "source": {...}
    }
  ]
}
```

**Key Fields**:

- `id`: Tank identifier (e.g., "DO.P", "FWB1.S")
- `category`: Tank category (fuel_oil, ballast, fresh_water, etc.)
- `loc`: Location in Frame notation (e.g., "Fr24-25")
- `fr_start`, `fr_end`: Frame range
- `cap_t`: Tank capacity (tonnes)
- `lcg_m`, `tcg_m`, `vcg_m`: Center of gravity coordinates (meters)
- `tcg_side`: Transverse side ("port", "stbd", "cl")

**Tank ID Convention**:

- Format: `{NAME}.{SIDE}`
- Examples:
  - `DO.P` = Diesel Oil, Port
  - `FWB1.S` = Forward Ballast 1, Starboard
  - `FW2.C` = Fresh Water 2, Centerline

**Usage**:

- Converted to `tank_ssot_for_solver.csv` by `convert_tank_catalog_json_to_solver_csv()`
- Coordinate conversion: `x_from_mid_m = MIDSHIP_FROM_AP_M - lcg_m`
- Used by Step 3 (Solver) and Step 4 (Optimizer)

**Important**: This is the **SSOT for tank properties**. All tank data must originate from this file.

---

### 3.3 `Frame_x_from_mid_m.json`

**Purpose**: Frame coordinate to x-from-midship conversion table

**Format**: Array of conversion entries

**Schema**:

```json
[
  {
    "Fr": 0.0,
    "x_from_mid_m": 30.15,
    "비고": "Ramp hinge"
  },
  {
    "Fr": 0.5,
    "x_from_mid_m": 29.65,
    "비고": ""
  }
]
```

**Key Fields**:

- `Fr`: Frame number
- `x_from_mid_m`: x-coordinate from midship (meters)
  - Positive = AFT
  - Negative = FWD
- `비고`: Notes (Korean)

**Conversion Formula**:

```
x_from_mid_m = MIDSHIP_FROM_AP_M - Fr
MIDSHIP_FROM_AP_M = 30.151 m
```

**Usage**:

- Used for coordinate system conversion
- Referenced when converting tank LCG from Frame to x-from-midship
- Required for solver input preparation

**Location Priority**:

1. `bplus_inputs/data/Frame_x_from_mid_m.json`
2. `02_RAW_DATA/Frame_x_from_mid_m.json` (fallback)

---

### 3.4 `LCT_BUSHRA_GM_2D_Grid.json`

**Purpose**: GM 2D interpolation grid for bilinear interpolation

**Source**: Aries Rev.3 stability calculations (2025-11-19)

**Schema**:

```json
{
  "description": "LCT BUSHRA GM 2D Grid - Aries Rev.3 실측 기반 최종 (2025-11-19)",
  "source": "STABILITY CALCULATION INITIAL CONDITION_20251026.pdf",
  "disp": [3200, 3400, 3600, 3800, 4000, 4200, 4250],
  "trim": [-1.5, -1.0, -0.5, 0.0, 0.5, 1.0, 1.5],
  "gm_grid": [
    [1.552, 1.598, 1.642, 1.685, 1.679, 1.618, 1.552],
    ...
  ]
}
```

**Key Fields**:

- `disp`: Displacement array (tonnes)
- `trim`: Trim array (meters, positive = trim by stern)
- `gm_grid`: 2D array of GM values (meters)
  - Rows = displacement indices
  - Columns = trim indices

**Interpolation Method**: Bilinear interpolation

- Input: `(Disp_t, Trim_m)`
- Output: `GM_m`

**Usage**:

- Used by `gm_2d_bilinear()` function
- Optional: If not available, falls back to hydrostatic table GM values
- Provides more accurate GM values for non-standard displacement/trim combinations

---

## 4. Subdirectories

### 4.1 `profiles/` - Site-Specific Profiles

**Purpose**: Site-specific configurations, gates, and operational parameters

#### 4.1.1 `AGI_site_profile_COMPLETE_v1.json`

**Purpose**: Complete AGI site profile with gates, tank overrides, and operational parameters

**Schema**:

```json
{
  "meta": {
    "site": "AGI",
    "version": "v1.0",
    "effective_date": "2025-12-25",
    "last_updated": "2025-12-25T00:00:00Z",
    "author": "Project Engineering Team",
    "description": "AGI Site SSOT Configuration - Phase 1 Complete"
  },
  "gates": [
    {
      "gate_id": "AFT_MIN_2p70_propulsion",
      "gate_name": "Gate-A: AFT Draft (Propulsion Safety)",
      "phase": "all_stages",
      "metric": "Draft_AFT",
      "comparator": ">=",
      "limit_value": 2.70,
      "unit": "m",
      "reference_frame": "MSL",
      "basis_doc": "AGENTS.md Section 4, Captain approval requirement",
      "owner": "Captain",
      "mandatory": true
    },
    {
      "gate_id": "FWD_MAX_2p70_critical_only",
      "gate_name": "Gate-B: FWD Draft (RoRo Critical Stages)",
      "phase": "critical_stages",
      "metric": "Draft_FWD",
      "comparator": "<=",
      "limit_value": 2.70,
      "unit": "m",
      "reference_frame": "CD",
      "owner": "Mammoet / Operations Manager",
      "mandatory": true
    }
  ],
  "tank_overrides": {...},
  "pump_scenarios": {...}
}
```

**Key Sections**:

- `gates`: Gate definitions (Gate-A, Gate-B, etc.)
- `tank_overrides`: Tank-specific overrides (capacity, operability, etc.)
- `pump_scenarios`: Pump rate configurations

**Usage**:

- Loaded by `gates_loader.py`
- Used for gate validation in Step 3 (Solver)
- Tank overrides applied during SSOT conversion

**Other Profile Files**:

- `AGI.json`: Simplified AGI profile
- `site_profile_AGI_aft_ballast_*.json`: AFT ballast-specific profiles

---

### 4.2 `sensors/` - Sensor Measurements

#### 4.2.1 `current_t_sensor.csv`

**Purpose**: Current tank levels from sensor measurements

**Schema**:

```csv
Tank,Current_t,Timestamp
FW2.P,13.92,2025-12-23T00:30:00Z
FW2.S,13.92,2025-12-23T00:30:00Z
FWB1.P,50.57,2025-12-23T08:30:00Z
FWB2.P,28.50,2025-12-25T16:00:00Z
```

**Key Columns**:

- `Tank`: Tank ID (must match `tank_catalog_from_tankmd.json`)
- `Current_t`: Current tank level (tonnes)
- `Timestamp`: Measurement timestamp (ISO 8601)

**Auto-Discovery**:

- Pipeline automatically searches for `current_t_*.csv` files
- Priority order:
  1. `sensors/current_t_sensor.csv`
  2. `02_RAW_DATA/sensors/current_t_*.csv`
  3. Any `current_t_*.csv` in search path

**Injection Process**:

1. `resolve_current_t_sensor_csv()`: Auto-discover sensor file
2. `inject_current_t_from_sensor_csv()`: Inject Current_t into tank SSOT
3. Exact match: Tank ID must match exactly
4. Audit log: `diff_audit.csv` records all injections

**Usage**:

- Injected into `tank_ssot_for_solver.csv` during SSOT conversion
- Used as initial condition for solver calculations
- Overrides default tank levels from catalog

**Important**: Sensor data takes precedence over catalog defaults.

---

### 4.3 `additional_inputs/` - Operational Criteria

#### 4.3.1 `Acceptance_Criteria.json`

**Purpose**: Operational acceptance criteria

**Schema**:

```json
{
  "_meta": {
    "generated_at": "2025-12-15T11:32:10.968700",
    "owner": "SCT",
    "tz": "Asia/Dubai"
  },
  "criteria": {
    "fwd_draft_max_m": 2.7,
    "fwd_draft_min_m": 1.5,
    "gm_target_m": 1.5,
    "ramp_angle_max_deg": 6.0,
    "wind_max_kt": null,
    "hs_max_m": null,
    "current_max_kt": null,
    "visibility_min_m": null,
    "ukc_min_m": null,
    "tide_window_rule": "TO_BE_FILLED"
  }
}
```

**Key Criteria**:

- `fwd_draft_max_m`: Maximum forward draft (2.70 m)
- `fwd_draft_min_m`: Minimum forward draft (1.5 m)
- `gm_target_m`: Target GM (1.5 m)
- `ramp_angle_max_deg`: Maximum ramp angle (6.0°)

#### 4.3.2 `GM_Min_Curve.json`

**Purpose**: Minimum GM curve by displacement

**Schema**:

```json
[
  {
    "Disp_t": 2524.4,
    "GM_min_m": 1.5
  },
  {
    "Disp_t": 2626.6,
    "GM_min_m": 1.5
  }
]
```

**Usage**: Used for GM validation at different displacement values

#### 4.3.3 Other Files

- `ISCODE_Criteria.json`: ISCODE (International Ship and Port Facility Security Code) criteria
- `Securing_Input.json`: Cargo securing requirements
- `Structural_Limits.json`: Structural load limits

---

### 4.4 `bplus_inputs/` - B+ System Inputs

#### 4.4.1 `Hydro_Table_Engineering.json`

**Purpose**: Hydrostatic table (engineering version) - SSOT for hydrostatic data

**Schema**:

```json
{
  "_meta": {
    "ship_name": "BUSHRA",
    "source": "STABILITY CALCULATION INITIAL CONDITION_20251026.pdf",
    "verified_by": "Aries / BV",
    "generated_by": "hydro_table_calculator.py",
    "lcf_reference": "midship",
    "lcf_ref": "MIDSHIP_AFT_POS",
    "x_convention": "AFT+",
    "fallbacks": {
      "LCF_m_from_midship": 0.76,
      "MCTC_t_m_per_cm": 34.0,
      "TPC_t_per_cm": 8.0
    }
  },
  "rows": [
    {
      "Tmean_m": 3.0,
      "Disp_t": 2524.4,
      "Trim_m": 0.0,
      "Draft_FWD": 3.0,
      "Draft_AFT": 3.0,
      "LCF_m": 0.76,
      "TPC_t_per_cm": 10.2,
      "MCTC_t_m_per_cm": 38.3,
      "KM_m": 12.341,
      "GM_m": 8.45,
      "GM_min_m": 1.5,
      "LCF_m_from_midship": 0.76
    }
  ]
}
```

**Key Fields**:

- `Tmean_m`: Mean draft (meters)
- `Disp_t`: Displacement (tonnes)
- `Trim_m`: Trim (meters, positive = trim by stern)
- `Draft_FWD`, `Draft_AFT`: Forward and aft drafts (meters)
- `LCF_m`: Longitudinal center of flotation (meters from AP)
- `TPC_t_per_cm`: Tons per centimeter immersion
- `MCTC_t_m_per_cm`: Moment to change trim one centimeter
- `KM_m`: Metacentric height above keel
- `GM_m`: Metacentric height above center of gravity

**Interpolation Method**: Linear interpolation for intermediate values

**Usage**:

- Converted to `hydro_table_for_solver.csv` by `convert_hydro_engineering_json_to_solver_csv()`
- Used by Step 1 (TR Excel generation) for draft/trim calculations
- Used by Step 3 (Solver) for hydrostatic interpolation

**Location Priority**:

1. `bplus_inputs/Hydro_Table_Engineering.json`
2. `02_RAW_DATA/bplus_inputs/Hydro_Table_Engineering.json` (fallback)

**Important**: This is the **SSOT for hydrostatic data**. All hydrostatic calculations must use this table.

---

## 5. Data Flow and SSOT Conversion

### 5.1 SSOT Conversion Process

```
Raw Data (02_RAW_DATA/)
    ↓
SSOT Conversion (PREP step)
    ↓
SSOT CSV Files
    ├── tank_ssot_for_solver.csv
    ├── hydro_table_for_solver.csv
    └── stage_table_unified.csv
    ↓
Pipeline Steps (Step 2, 3, 4, 5)
```

### 5.2 Tank SSOT Conversion

**Input**: `tank_catalog_from_tankmd.json` + `current_t_sensor.csv` + `AGI_site_profile_COMPLETE_v1.json`

**Process**:

1. `convert_tank_catalog_json_to_solver_csv()`: Convert JSON to CSV
2. Coordinate conversion: `x_from_mid_m = MIDSHIP_FROM_AP_M - lcg_m`
3. `inject_current_t_from_sensor_csv()`: Inject sensor measurements
4. `apply_tank_overrides_from_profile()`: Apply profile overrides

**Output**: `tank_ssot_for_solver.csv`

### 5.3 Hydro SSOT Conversion

**Input**: `Hydro_Table_Engineering.json`

**Process**:

1. `convert_hydro_engineering_json_to_solver_csv()`: Convert JSON to CSV
2. Extract required columns: `Tmean_m`, `Disp_t`, `Trim_m`, `LCF_m`, `TPC_t_per_cm`, `MCTC_t_m_per_cm`

**Output**: `hydro_table_for_solver.csv`

### 5.4 Stage SSOT Conversion

**Input**: `stage_results.csv`

**Process**:

1. `build_stage_table_from_stage_results()`: Build stage table
2. Add tide data (if available)
3. Add UKC calculations

**Output**: `stage_table_unified.csv`

---

## 6. Usage Guidelines

### 6.1 File Modification

**DO NOT**:

- ❌ Modify raw data files directly during pipeline execution
- ❌ Create duplicate data files
- ❌ Hardcode values that should come from these files

**DO**:

- ✅ Update source files (e.g., `tank.md`) and regenerate JSON
- ✅ Use SSOT conversion functions to create solver inputs
- ✅ Always reference these files as the source of truth

### 6.2 File Location Priority

The pipeline searches for files in the following order:

1. **Command-line specified path** (`--inputs_dir`)
2. **bplus_inputs/** (if `--bplus_strict` flag is set)
3. **02_RAW_DATA/** (fallback)

### 6.3 Data Validation

Before running the pipeline:

1. **Verify file existence**: All required files must exist
2. **Check file format**: JSON files must be valid JSON
3. **Validate schema**: Ensure required fields are present
4. **Check sensor data**: Verify `current_t_sensor.csv` has recent timestamps

---

## 7. Data Validation

### 7.1 Required Files Checklist

- [ ] `tank_catalog_from_tankmd.json` - Tank catalog
- [ ] `Hydro_Table_Engineering.json` - Hydrostatic table
- [ ] `stage_results.csv` - Stage definitions (or will be generated in Step 1b)
- [ ] `AGI_site_profile_COMPLETE_v1.json` - Site profile
- [ ] `current_t_sensor.csv` - Sensor measurements (optional but recommended)
- [ ] `Frame_x_from_mid_m.json` - Frame conversion table

### 7.2 Data Quality Checks

**Tank Catalog**:

- All tanks have valid `id`, `cap_t`, `lcg_m`, `tcg_m`, `vcg_m`
- Tank IDs match sensor CSV format
- No duplicate tank IDs

**Hydrostatic Table**:

- `Disp_t` values are monotonically increasing
- `Tmean_m` values are within valid range (typically 1.5 - 4.0 m)
- All required columns present

**Sensor Data**:

- Tank IDs match catalog
- `Current_t` values are within tank capacity
- Timestamps are recent (within 24 hours recommended)

---

## 8. Troubleshooting

### 8.1 Common Issues

**Issue**: "File not found" error

**Solution**:

- Check file location priority order
- Verify `--inputs_dir` path is correct
- Ensure file exists in fallback location (`02_RAW_DATA/`)

**Issue**: "Invalid JSON" error

**Solution**:

- Validate JSON syntax using a JSON validator
- Check for trailing commas or missing quotes
- Ensure file encoding is UTF-8

**Issue**: "Tank ID mismatch" in sensor data

**Solution**:

- Verify tank IDs in `current_t_sensor.csv` match `tank_catalog_from_tankmd.json`
- Check for typos or case sensitivity issues
- Review `diff_audit.csv` for injection failures

**Issue**: "Coordinate conversion error"

**Solution**:

- Verify `Frame_x_from_mid_m.json` exists
- Check `MIDSHIP_FROM_AP_M` constant (should be 30.151 m)
- Ensure Frame numbers are within valid range

### 8.2 Data Update Procedure

1. **Update source file** (e.g., `tank.md`)
2. **Regenerate JSON** (if applicable)
3. **Validate new data** (check schema, ranges)
4. **Update sensor data** (if tank levels changed)
5. **Run pipeline** with `--from_step 0` to regenerate all outputs

---

## 9. References

- **Pipeline Architecture**: `03_DOCUMENTATION/00_CORE_ARCHITECTURE/Pipeline Complete Architecture and Exe.md`
- **Data Flow**: `03_DOCUMENTATION/00_CORE_ARCHITECTURE/02_Data_Flow_SSOT.md`
- **SSOT Principles**: `03_DOCUMENTATION/00_CORE_ARCHITECTURE/파이프라인 전체 아키텍처, 실행 파일, 로직 상세 설명.MD` Section 4

---

## 10. Version History

- **v1.0 (2025-12-30)**: Initial comprehensive guide
  - Complete file descriptions
  - SSOT conversion process
  - Usage guidelines
  - Troubleshooting section

---

**Last Updated**: 2025-12-30
**Maintained By**: Project Engineering Team
